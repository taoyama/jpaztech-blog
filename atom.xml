<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/"/>
  <updated>2019-10-17T11:18:44.258Z</updated>
  <id>https://jpaztech.github.io/</id>
  
  <author>
    <name>Japan Azure IaaS Support Team</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Japan Azure IaaS Support Blog リニューアルのお知らせ</title>
    <link href="https://jpaztech.github.io/information/test/"/>
    <id>https://jpaztech.github.io/information/test/</id>
    <published>2019-09-13T09:29:20.000Z</published>
    <updated>2019-10-17T11:18:44.258Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure IaaS Support チームです。</p><p><font color="gray">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</font></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure IaaS Support チームです。&lt;/p&gt;
&lt;p&gt;&lt;font color=&quot;gray&quot;&gt;本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。&lt;/font&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="Information" scheme="https://jpaztech.github.io/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway (WAF) での脆弱性検知について</title>
    <link href="https://jpaztech.github.io/archive/application-gateway-waf-vulnerability-detection/"/>
    <id>https://jpaztech.github.io/archive/application-gateway-waf-vulnerability-detection/</id>
    <published>2018-10-18T00:27:51.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの山崎です。<br>今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。</p><h2 id="■-WAF-機能で検知した情報をログから確認したい"><a href="#■-WAF-機能で検知した情報をログから確認したい" class="headerlink" title="■ WAF 機能で検知した情報をログから確認したい"></a>■ WAF 機能で検知した情報をログから確認したい</h2><p>一般的な WAF の導入シナリオとして、WAF 機能をいきなり本番環境に導入してしまうとフォールスポジティブや (誤検知) フォールスネガティブ (見逃し) に合致してしまう可能性があります。<br>そのため、まずは本番導入前に通信の破棄は行わず、検知のみを行ってログ情報からフォールスポジティブ、フォールスネガティブが発生していないか確認したいというご要望を多くいただきます。<br>Application Gateway の WAF 機能でも検知モード、ログ出力に対応しており、以下を設定することで導入前のテストを実施いただけます。</p><h3 id="検知モード-防止モード"><a href="#検知モード-防止モード" class="headerlink" title="検知モード / 防止モード"></a>検知モード / 防止モード</h3><p>検知モードでは脆弱性の診断は実施されますが、対象の通信が異常と判定された場合でも通信をブロックせず、後述の Firewall ログにログを保存します。<br>防止モードでは異常と判定された通信をログに保存しつつ、通信もブロックします。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_mode.png"><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_403_error.png"><h3 id="Firewall-ログ"><a href="#Firewall-ログ" class="headerlink" title="Firewall ログ"></a>Firewall ログ</h3><p>脆弱性を検知したログを保存するためには、診断ログの “ApplicationGatewayFirewallLog” を設定します。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [診断ログ] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_firewalllog.png"><h2 id="■-Firewall-ログについて"><a href="#■-Firewall-ログについて" class="headerlink" title="■ Firewall ログについて"></a>■ Firewall ログについて</h2><p>以下は OWASP 3.0 を利用し SQL Injection Attack を検知した際の Firewall ログです。脆弱性が検知された通信毎にログが記録されます。1つの通信に対して複数の脆弱性を検知した場合には、複数の情報が出力されます。<br>複数検知されたかどうかについては “time”, “requestUri”, “clientIp” の項目が同じかどうかで判断することが可能です。</p><pre>{  "records": [    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "942130",        "message": "SQL Injection Attack: SQL Tautology Detected.",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"(?i:([\\\\s'\\\"`\\\\(\\\\)]*?)([\\\\d\\\\w]++)([\\\\s'\\\"`\\\\(\\\\)]*?)(?:(?:=|<=>|r?like|sounds\\\\s+like|regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)\\\\2|(?:!=|<=|>=|<>|<|>|\\\\^|is\\\\s+not|not\\\\s+like|not\\\\s+regexp)([\\\\s'\\\"`\\\\(\\\\)]*?)(?!\\\\2)([\\\\d\\\\w]+)))\" at ARGS:.",          "data": "Matched Data: rx ^0 found within ARGS:: !@rx ^0$",          "file": "rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf",          "line": "554"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    },    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T10:01:31.3790913Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "//?=!@rx%20%5E0$",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "949110",        "message": "Mandatory rule. Cannot be disabled. Inbound Anomaly Score Exceeded (Total Score: 5)",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Access denied with code 403 (phase 2). Operator GE matched 5 at TX:anomaly_score.",          "data": "",          "file": "rules/REQUEST-949-BLOCKING-EVALUATION.conf",          "line": "57"        },        "hostname": "1fe5ea76-fd34-480c-9b8d-a0b0d35cd19e.cloudapp.net"      }    }  ]}</|></=|></=></pre><h2 id="■-“949110”-ルールの検知"><a href="#■-“949110”-ルールの検知" class="headerlink" title="■ “949110” ルールの検知"></a>■ “949110” ルールの検知</h2><p>OWASP 3.0 ではスコア判定方式で対象の通信を判定しており、スコアを超えた（= 異常通信と判定した）場合に “949110” が判定されます。上記 Firewall ログの例では SQL Injection Attack を検知した “942130” と、スコア判定によりスコアを超えたことを示す “949110” の2つが検知されています。</p><p>ここで、例えば今回脆弱性として検知された通信について、実はフォールスポジティブで誤検知されてしまったため、検知を無効化して通信を許可したい場合、以下設定による個別の検知ルールの無効化が可能です。</p><h3 id="個別ルールの設定-無効化、有効化"><a href="#個別ルールの設定-無効化、有効化" class="headerlink" title="個別ルールの設定 (無効化、有効化)"></a>個別ルールの設定 (無効化、有効化)</h3><p>Firewall ログから検知した “ruleId” を確認し、同じ番号のルールを探して検知の無効化、有効化を設定することができます。</p><p>（設定例）[Azure ポータル] Application Gateway 設定の [Web アプリケーション ファイアウォール] から設定します。</p><img src="/blog/archive/application-gateway-waf-vulnerability-detection/waf_tayamasa_rulesetes.png"><p>よくあるお問い合わせとして、同様に “949110” を無効化しようと設定を確認したところ、”949110” の設定項目がないというお問い合わせをいただきます。</p><p>ご確認いただいた通り、”949110” については WAF 設定で有効/無効を切り替えることは出来ませんが、今回の例の場合、SQL Injection Attack を検知した “942130” を無効化いただければ、”949110” も検知されなくなります。前述の通り、OWSAP 3.0 ではスコア判定方針でスコアを超えた場合に “949110” が検知されますが、”942130” を無効化いただくことでスコア判定のスコアに加算されないため “949110” でも検知されなくなるためです。</p><p>そのため、”949110” については個別に無効化する必要はなく、”949110” とともに検知されたルールをご確認いただき、無効化いただくことで制御することが可能です。</p><blockquote><p>[参考] OWASP 2.2.9 ではスコア判定方式ではないため “949110” が Firewall ログに出力されることはありません。</p></blockquote><h2 id="■-Firewall-ログで検知しているのに通信がブロックされない"><a href="#■-Firewall-ログで検知しているのに通信がブロックされない" class="headerlink" title="■ Firewall ログで検知しているのに通信がブロックされない"></a>■ Firewall ログで検知しているのに通信がブロックされない</h2><p>OWASP 3.0 で防止モードご利用の際、Firewall ログで脆弱性を検知しているにも関わらず通信がブロックされない場合があります。<br>（ログ例）</p><pre>    {      "resourceId": "/SUBSCRIPTIONS/xxxxxxxxxxxxxxxx/RESOURCEGROUPS/APPGW_TEST01/PROVIDERS/MICROSOFT.NETWORK/APPLICATIONGATEWAYS/APPGW02_WAF",      "operationName": "ApplicationGatewayFirewall",      "time": "2018-10-29T11:39:47.2243486Z",      "category": "ApplicationGatewayFirewallLog",      "properties": {        "instanceId": "ApplicationGatewayRole_IN_0",        "clientIp": "167.220.232.101",        "clientPort": "0",        "requestUri": "/vendor/bootstrap/css/bootstrap.min.css.map",        "ruleSetType": "OWASP",        "ruleSetVersion": "3.0",        "ruleId": "920350",        "message": "Host header is a numeric IP address",        "action": "Blocked",        "site": "Global",        "details": {          "message": "Warning. Pattern match \"^[\\\\d.:]+$\" at REQUEST_HEADERS:Host.",          "data": "40.114.66.69",          "file": "rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf",          "line": "791"        },        "hostname": "40.114.66.69"      }    }</pre><p>通信が異常と判定された場合には “949110” が検知されますので、上記のログのような “920350” で検知し、スコア加算されたとしても、異常と判定されるスコアを超えない場合には通信はブロックされず、許可される場合があります。<br>そのため、通信がブロックされたかどうかを確認する場合には “949110” が同時に検知されているかどうかを Firewall ログからご確認ください。</p><blockquote><p>スコア判定の基準については OWASP で管理されており、OWASP CRS の各ルールや、その判定条件についてはサポートチームとしては回答が出来かねますため、GitHub のリポジトリをご参照いただくか、OWASP コミュニティのメーリングリスト等へご相談いただけますと幸いです。</p><p>[参考] <a href="https://jpaztech.github.io/blog/archive/applicationgaetway-waf-01/">Application Gateway で利用できる WAF について </a></p></blockquote><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの山崎です。&lt;br&gt;今回は Application Gateway で Web アプリケーション ファイアウォール（WAF） 機能をご利用の際によくお問い合わせをいただく “949110” ルールについてご紹介します。&lt;/p&gt;
&lt;h2 
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>(PowerShell編) Azure仮想マシン (管理ディスク) の交換を活用して元のネットワークにリストアする</title>
    <link href="https://jpaztech.github.io/archive/restore-vm-by-swap-manageddisk/"/>
    <id>https://jpaztech.github.io/archive/restore-vm-by-swap-manageddisk/</id>
    <published>2018-06-04T06:31:32.000Z</published>
    <updated>2019-10-17T11:18:44.258Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートチームの三國です。<br>今回は 2018 年 4 月にリリースされた、管理ディスクの交換 (スワップ) 機能を用いて仮想マシンを元のネットワークにリストアする方法をご案内します。</p><p>本ブログは Azure PowerShell 編です。ポータルでの手順は以下の投稿をご参照下さい。<br><a href="http://blogs.technet.microsoft.com/jpaztech/2018/05/30/restore-vm-by-swap-manageddisk/" target="_blank" rel="noopener">(旧) Azure 仮想マシン (管理ディスク) の交換を活用して元のネットワークにリストアする</a></p><p><span style="color:red;">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="■-注意事項"><a href="#■-注意事項" class="headerlink" title="■ 注意事項"></a>■ 注意事項</h2><ul><li>Azure PowerShell のバージョンは 6.1.0 にて検証を行っておりますが、バージョンによってパラメータが異なる可能性や実行頂けない可能性があります。</li><li>ストレージアカウントに vhd が作成され、管理ディスクが新規で作成されます。</li><li>リストアする仮想マシンの情報を記載した json ファイルが PowerShell 実行元のローカルにダウンロードされます。</li><li>バックアップは別途取得頂く必要がございます。</li><li>仮想マシンの停止が発生します。</li><li>仮想マシンのリストアが行われますので、実行には長時間を要します。</li><li><span style="color:red;">サンプルのスクリプトである為、責任は一切負いかねます。十分に検証いただいた上でご利用をお願いいたします。</span></li></ul><h2 id="■-はじめに"><a href="#■-はじめに" class="headerlink" title="■ はじめに"></a>■ はじめに</h2><p>Azure Backup での仮想マシンの復元には2つの選択肢があります。</p><ul><li>特定の時点のバックアップ VM である VM を新しく作成する。</li><li>ディスクを復元し、そのプロセスに含まれるテンプレートを使用して、復元された VM をカスタマイズするか、個別にファイルを回復する。</li></ul><p><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms" target="_blank" rel="noopener">(参考) Azure Portal を使用して仮想マシンを復元する</a></p><p>しかし、可能であれば復元前の仮想マシンと同じネットワークにリストアしたいというニーズも強くあるかと存じます。<br>そこで、以下のような手順で実現する方法をご案内いたします。</p><ol><li>仮想マシンのディスクを VHD に復元する</li><li>VHD を管理ディスク化する</li><li>復元後のディスクを復元前のディスクと交換する (仮想マシンの停止が伴います)</li></ol><p>これは、2018年4月より管理ディスクでも可能になった機能を用いております。<br><a href="https://blogs.technet.microsoft.com/jpitpro/2018/05/11/os-disk-swap-managed-disks/" target="_blank" rel="noopener">(参考) Managed Virtual Machines で OS ディスク スワップの一般提供を開始</a></p><p>それでは、サンプルスクリプトおよび使用法をご案内します。</p><h2 id="■-サンプルスクリプトの使用法"><a href="#■-サンプルスクリプトの使用法" class="headerlink" title="■ サンプルスクリプトの使用法"></a>■ サンプルスクリプトの使用法</h2><p>‘変数の指定’ における各変数をカスタマイズしてご利用ください。<br>過去 7 日間に取得した Backup のうち最新のものをリストアする動作となります。</p><p>リストア先のストレージアカウントにおいて、自動で決められたコンテナ名、vhd 名で vhd がリストアされますが、作成される管理ディスク名は指定する必要があります。スクリプトでは接頭辞を付ける動作としております。<br>(例: ‘testdisk’ というディスク名なら ‘res-testdisk’ となります)</p><p>その他ご不明点等ございましたらコメント欄に記載ください。</p><h2 id="■-サンプルスクリプト"><a href="#■-サンプルスクリプト" class="headerlink" title="■ サンプルスクリプト"></a>■ サンプルスクリプト</h2><pre>########################################################## 変数の指定########################################################$subscriptionId = 'xxxxx-xxxxx-xxxxx-xxxxx-xxxxx'# 仮想マシンのリソース グループ名$vmResourceGroupName = 'sample-RG'# 仮想マシン名$vmName = 'sample-VM'# Backup の vault 名$vaultName = 'sample-vault'# ストレージ アカウントのリソース グループ名$storageAccountResourceGroupName = 'sample-RG'# ストレージ アカウント名$storageAccountName = 'samplestorage'# リストア用の管理ディスクの接頭辞$prefix = 'res-'########################################################## ログイン、サブスクリプションの選択########################################################Login-AzureRmAccountSelect-AzureRmSubscription -SubscriptionId $subscriptionId########################################################## リストア・管理ディスク作成の準備######################################################### 過去7日間に取得したBackUpのうち最新のものをディスクにリストアGet-AzureRmRecoveryServicesVault -Name $vaultName | Set-AzureRmRecoveryServicesVaultContext$namedContainer = Get-AzureRmRecoveryServicesBackupContainer  `  -ContainerType "AzureVM"  `  -Status "Registered"  `  -FriendlyName $vmName$backupitem = Get-AzureRmRecoveryServicesBackupItem  ` -Container $namedContainer  ` -WorkloadType "AzureVM"$startDate = (Get-Date).AddDays(-7)$endDate = Get-Date$rp = Get-AzureRmRecoveryServicesBackupRecoveryPoint  `  -Item $backupitem  `  -StartDate $startdate.ToUniversalTime()  `  -EndDate $enddate.ToUniversalTime()$restorejob = Restore-AzureRmRecoveryServicesBackupItem  `  -RecoveryPoint $rp[0]  `  -StorageAccountName $storageAccountName  `  -StorageAccountResourceGroupName $storageAccountResourceGroupNameWait-AzureRmRecoveryServicesBackupJob -Job $restorejob -Timeout 43200# Config JsonのURI取得$job = Get-AzureRmRecoveryServicesBackupJobDetails -JobId $restorejob.JobId$jsonContainer = $job.Properties["Config Blob Container Name"]$jsonBlob = $job.Properties["Config Blob Name"]# Config Jsonのダウンロード$ctx = (Get-AzureRmStorageAccount  `  -ResourceGroupName $storageAccountResourceGroupName  `  -Name $storageAccountName).ContextGet-AzureStorageBlobContent -Blob $jsonBlob -Container $jsonContainer -Destination .\  -Context $ctx # Jsonのオブジェクト化$jsonObj = (Get-Content .\$jsonBlob -Encoding Unicode -Raw).TrimEnd([char]0x00) |ConvertFrom-Json# VMオブジェクトの取得 $vmObj = Get-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName########################################################## OSディスクの作成######################################################### OSディスクの作業用オブジェクトの作成$osDiskObj = $jsonObj.'properties.storageProfile'.osDisk# 現在のOSディスク情報の取得$currentOSdisk = Get-AzureRmDisk  `  -ResourceGroupName $vmResourceGroupName  `  -DiskName $vmObj.StorageProfile.OsDisk.Name# 管理ディスクの作成(OSディスク)$newOsDiskName = $prefix + $currentOSdisk.Name$osDiskConfig = New-AzureRmDiskConfig  `  -Location $vmObj.Location  `  -AccountType $currentOSdisk.Sku.Name  `  -CreateOption Import  `  -OsType $vmObj.StorageProfile.OsDisk.OsType  `  -SourceUri $osDiskObj.vhd.uri$newOSdisk = New-AzureRmDisk  `  -ResourceGroupName $vmResourceGroupName  `  -DiskName $newOsDiskName  `  -Disk $osDiskConfig########################################################## データディスクの作成######################################################### データディスクの作業用オブジェクトの作成$dataDiskObj = $jsonObj.'properties.storageProfile'.dataDisks$currentDataDiskObj = $vmObj.StorageProfile.DataDisks$newDataDiskArray = @()if ($dataDiskObj){    $dataDiskObj | foreach{        $lunNum = $_.Lun        # 現在のデータディスク情報の取得        $currentDataDiskName = ($currentDataDiskObj | Where-Object {$_.Lun -eq $lunNum}).Name        $currentDataDisk = Get-AzureRmDisk -ResourceGroupName $vmResourceGroupName -DiskName $currentDataDiskName        # 管理ディスクの作成(データディスク)        $newDataDiskName = $prefix + $currentDatadiskName        $dataDiskConfig = New-AzureRmDiskConfig -Location $vmObj.Location -AccountType $currentDatadisk.Sku.Name -CreateOption Import -SourceUri $_.vhd.uri        $newDataDisk = New-AzureRmDisk -ResourceGroupName $vmResourceGroupName -DiskName $newDataDiskName -Disk $dataDiskConfig        $newDataDiskArray = $newDataDiskArray + $newDataDisk    }}########################################################## 仮想マシンの停止######################################################### 仮想マシンを停止するStop-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName -Force########################################################## OSディスクの差し替え######################################################### 最新状態のVMオブジェクトの取得 $vmObj = Get-AzureRmVM -ResourceGroupName $vmResourceGroupName -Name $vmName# OSディスクの差し替え  Set-AzureRmVMOSDisk -VM $vmObj -ManagedDiskId $newOSdisk.Id -Name $newOSdisk.Name# 仮想マシン情報の更新をするUpdate-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj ########################################################## データディスクの差し替え########################################################if ($dataDiskObj){    $dataDiskObj | foreach{        $lunNum = $_.Lun        # デタッチするデータディスク情報の取得        $currentDataDiskName = ($currentDataDiskObj | Where-Object {$_.Lun -eq $lunNum}).Name        # アタッチするデータディスクオブジェクトの取得        $sourceVhd = $_.vhd.uri        $newDataDiskObj = $newDataDiskArray | Where-Object {$_.CreationData.SourceUri -eq $sourceVhd}        # 既存のデータディスクのデタッチ        Remove-AzureRmVMDataDisk -VM $vmObj -DataDiskNames $currentDataDiskName        # 仮想マシン情報の更新をする        Update-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj        # 新規のデータディスクのアタッチ        Add-AzureRmVMDataDisk -VM $vmObj -CreateOption Attach -Lun $_.lun -ManagedDiskId $newDataDiskObj.Id        # 仮想マシン情報の更新をする        Update-AzureRmVM -ResourceGroupName $vmResourceGroupName -VM $vmObj    }}########################################################## 仮想マシンの起動######################################################### 仮想マシンを起動するStart-AzureRmVM -Name $vmName -ResourceGroupName $vmResourceGroupName</pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。Azure サポートチームの三國です。&lt;br&gt;今回は 2018 年 4 月にリリースされた、管理ディスクの交換 (スワップ) 機能を用いて仮想マシンを元のネットワークにリストアする方法をご案内します。&lt;/p&gt;
&lt;p&gt;本ブログは Azure PowerShell 
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="PowerShell" scheme="https://jpaztech.github.io/tags/PowerShell/"/>
    
      <category term="Managed Disk" scheme="https://jpaztech.github.io/tags/Managed-Disk/"/>
    
      <category term="Backup / Restore" scheme="https://jpaztech.github.io/tags/Backup-Restore/"/>
    
  </entry>
  
  <entry>
    <title>5 月のセキュリティ更新を適用後、Windows 仮想マシンに RDP 接続時にエラーが発生する事象の回避策</title>
    <link href="https://jpaztech.github.io/archive/mayupdate_unable-to-rdp/"/>
    <id>https://jpaztech.github.io/archive/mayupdate_unable-to-rdp/</id>
    <published>2018-05-17T06:19:37.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>Azure サポートチームの石井です。<br>2018 年 5 月第 2 週目頃から、突然 Windows 仮想マシンに RDP すると以下のエラーが出て接続が出来なくなったというケースが報告されています。</p><img src="/blog/archive/mayupdate_unable-to-rdp/mayupdate_unable-to-rdp.png"><p>このエラーは、5 月にリリースされたセキュリティ更新プログラムの影響です。接続元側にのみ、5 月の更新プログラムが適用されており、接続先の VM に 3 月以降の更新プログラムが未適用の場合に当該の状況が発生します。Windows Update の自動更新をせず、自社にてタイミングを管理しているようなお客様に該当する恐れがあります。</p><p>以下の Windows サポート部門からの情報に詳しくまとめられていますので、お読みいただき、回避策を実施下さい。</p><p>2018 年 5 月の更新プログラム適用によるリモート デスクトップ接続への影響<br><a href="https://blogs.technet.microsoft.com/askcorejp/2018/05/02/2018-05-rollup-credssp-rdp/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/askcorejp/2018/05/02/2018-05-rollup-credssp-rdp/</a><br><span style="color:gray;">※ Ask CORE Blog は 2019 年 3 月をもちまして、弊社システム刷新の都合により終了いたしました。<br>※ 2019 年 8 月現在、過去の記事を閲覧することは可能でございますが、予告なく削除される可能性がございます</span></p><p>端的にいうと、以下の対策となります。</p><ol><li>回避策の項にある 1 ないしは 2 をクライアント側で実施することで、まずはエラーを回避して RDP 接続が行えるようになります。</li><li>サーバー側で “5. 参考情報” に記載のセキュリティ更新プログラムを適用します。</li></ol><p>-&gt; 更新プログラムの適用が難しい場合、サーバー側でポリシーを当てることで回避が出来ますが、セキュリティ レベルが低くなるため、あくまで暫定回避策とお考え下さい。</p><h3 id="lt-5-27-更新-gt-以下の事象は解消済みです。"><a href="#lt-5-27-更新-gt-以下の事象は解消済みです。" class="headerlink" title="&lt;5/27 更新&gt; 以下の事象は解消済みです。"></a>&lt;5/27 更新&gt; 以下の事象は解消済みです。</h3><p><del>※ 補足: Azure Marketplace のイメージにおいて、Windows 10 クライアント イメージでも事象が発生しますため、上記の回避策を実施して下さい。Azure Marketplace のイメージは、都度のセキュリティ更新プログラムを適用し、開発部門でテスト後に更新されていくため、<a href="https://docs.microsoft.com/ja-jp/azure/security/azure-security-best-practices-vms#manage-your-vm-updates" target="_blank" rel="noopener">数週間の遅延が発生する可能性があります</a>。今回の事象を受け、弊サポート部からも開発に、更新版のイメージのリリースを急ぐようプッシュをかけております。解消までの間、今しばらくお待ちください。</del></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Azure サポートチームの石井です。&lt;br&gt;2018 年 5 月第 2 週目頃から、突然 Windows 仮想マシンに RDP すると以下のエラーが出て接続が出来なくなったというケースが報告されています。&lt;/p&gt;
&lt;img src=&quot;/blog/archive/mayup
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="RDP" scheme="https://jpaztech.github.io/tags/RDP/"/>
    
      <category term="Update / Upgrade" scheme="https://jpaztech.github.io/tags/Update-Upgrade/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway における 502 Error について</title>
    <link href="https://jpaztech.github.io/archive/application-gateway-502-error-info/"/>
    <id>https://jpaztech.github.io/archive/application-gateway-502-error-info/</id>
    <published>2018-03-16T11:39:33.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、Azure テクニカルサポートの平原です。<br>今回のトピックでは、比較的お問い合わせをいただくものである Application Gateway (Reverse Proxy) における 502 エラーについて解説させていただきます。<br>ご案内内容がお役に立てば幸いです。</p><h2 id="■-Http-Status-Code-502-とは"><a href="#■-Http-Status-Code-502-とは" class="headerlink" title="■ Http Status Code 502 とは"></a>■ Http Status Code 502 とは</h2><p>Application Gateway を使っている過程で、HTTP ステータスコード 502 エラーに遭遇することがあります。<br>おそらく多くの人が、Application Gateway を使う過程でご覧いただいたことがあるものなのでは、と思います。<br>一番簡単に出す方法は、Application Gateway を作成して、バックエンドに何も入れずに、作ったサーバーにアクセスすれば、502 エラーが返ります。<br>まずは、502 エラーはどういうものなのかを見ていきます。</p><p>HTTPステータスコード<br><a href="https://ja.wikipedia.org/wiki/HTTPステータスコード" target="_blank" rel="noopener">https://ja.wikipedia.org/wiki/HTTPステータスコード</a></p><p>Wikipedia ですと、以下のような記述があります。</p><blockquote><p>502 Bad Gateway : 不正なゲートウェイ。ゲートウェイ・プロキシサーバは不正な要求を受け取り、これを拒否した。</p></blockquote><p>もう少し正確な情報で、RFC を見てみると、502 Bad Gateway に関する記述があります。</p><p>Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content<br><a href="https://tools.ietf.org/html/rfc7231#section-6.6.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7231#section-6.6.3</a></p><blockquote><p>6.6.3.  502 Bad Gateway<br>The 502 (Bad Gateway) status code indicates that the server, while<br>acting as a gateway or proxy, received an invalid response from an<br>inbound server it accessed while attempting to fulfill the request.</p></blockquote><p>すなわち、ゲートウェイなりプロキシなりの機能を有しているサーバーが接続先のサーバーに対して有効な情報を得られないときに症状が出るものになります。<br>そう考えると、Application Gateway もプロキシですので、何もバックエンドにサーバーを設定していないときや、バックエンドに接続できないときなどは、502 エラーを返すことになります。</p><h2 id="■-Application-Gateway-における-502-エラー"><a href="#■-Application-Gateway-における-502-エラー" class="headerlink" title="■ Application Gateway における 502 エラー"></a>■ Application Gateway における 502 エラー</h2><p>では、どういうときに 502 エラーを返すのでしょうか？<br>Application Gateway の場合は、よくある症状として、以下の時に 502 エラーを返すことがあります。</p><ul><li>バックエンドサーバーに何もない時。</li><li>バックエンドサーバーの正常性チェックで、すべてのサーバーがダウンしているとき。</li><li>バックエンドサーバーが、リセットパケットを返すとき。</li><li>バックエンドサーバーへの接続が、タイムアウトした時。</li><li>バックエンドサーバーへの名前解決に失敗する場合</li></ul><p>もし症状に遭遇した時には、この観点で見ていく必要があります。<br>とくに、今まで動いていたものが、急に 502 を返すようになったという症状の場合には、バックエンドの正常性を疑ってみてください。</p><h2 id="■-トラブルシュート方法"><a href="#■-トラブルシュート方法" class="headerlink" title="■ トラブルシュート方法"></a>■ トラブルシュート方法</h2><p>トラブルシュート方法としては、マイクロソフトの用意しているドキュメントによくまとまっていますので、こちらをご参考ください。</p><p>Application Gateway での「無効なゲートウェイ」によるエラーのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502</a></p><p>よくある問題は以下の通りです。</p><ul><li>ネットワーク セキュリティ グループ、ユーザー定義ルート、またはカスタム DNS に関する問題</li><li>既定の正常性プローブに関する問題</li><li>カスタムの正常性プローブに関する問題</li><li>要求のタイムアウト</li><li>空の BackendAddressPool</li><li>BackendAddressPool の異常なインスタンス</li></ul><h2 id="■-参考情報"><a href="#■-参考情報" class="headerlink" title="■ 参考情報"></a>■ 参考情報</h2><p>これ以外の情報で、バックエンドに Apache にてリバースプロキシーを構築し、プロキシーの 2 段構成にした場合に、散発的に 502 エラーが発生することが報告されています。<br>これは、Apache をご利用の際に、他の環境でも 2 段構成にすると事象が発生することが報告されているようです。<br>もし遭遇された場合は、Apache 側の構成で Keep Alive を OFF にすることで事象回避の報告があるようですので、もし同じ事象に合われましたらお試しください。</p><p>Web 上を検索すると種々方法はあるようですので、Apache に関して検索をかけていただくと別の方法もある可能性があります。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;皆さんこんにちは、Azure テクニカルサポートの平原です。&lt;br&gt;今回のトピックでは、比較的お問い合わせをいただくものである Application Gateway (Reverse Proxy) における 502 エラーについて解説させていただきます。&lt;br&gt;ご案内内容
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>2018 年 1 月 4 日以降で Disk 11 のエラーが発生し MARS Agent バックアップが失敗する (0x8007045D)</title>
    <link href="https://jpaztech.github.io/archive/disk11-after20180104/"/>
    <id>https://jpaztech.github.io/archive/disk11-after20180104/</id>
    <published>2018-01-23T14:15:17.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;">※ 2018/02/01 更新<br>修正版の MARS Agent が公開されましたので、更新方法を追記いたしました。</span></p><p>こんにちは、Azure IaaS Support チームです。</p><p>本日は 1 月 4 日に発生しましたメンテナンスによる仮想マシンの再起動以降、Azure VM で MARS Agent によるファイルとフォルダーのバックアップが「仮想ディスク サービスで予期しないエラーが発生したため、バックアップを開始できませんでした。 I/O デバイス エラーが発生したため、要求を実行できませんでした。 (0x8007045D)」のメッセージで失敗する弊社製品不具合の事象についてご案内いたします。</p><p><span style="color:gray;">※ 本情報の内容（添付文書、リンク先などを含む）は作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="■-事象について"><a href="#■-事象について" class="headerlink" title="■ 事象について"></a>■ 事象について</h2><p>MARS Agent による Azure VM のファイルとフォルダーのバックアップが下記イベント ID 11 の記録とともに失敗します。</p><img src="/blog/archive/disk11-after20180104/diskerr.jpg"><p>当該事象はバックアップ取得時に作成される VHD ファイルのマウント/アンマウントの内部処理に問題があり、IO エラー (0x8007045D) が返されることでバックアップが失敗します。<br>根本原因としては、Agent の処理に問題があることが分かっており現在 Microsoft 開発チームにて修正対応が進められております。</p><h2 id="■-対処策"><a href="#■-対処策" class="headerlink" title="■ 対処策"></a>■ 対処策</h2><p>本事象につきましては、回避策としてキャッシュの場所変更がございます。<br>VM に OS ディスク以外のデータ ディスクが接続されている場合にはキャッシュの場所変更についてご検討をいただけますようお願いいたします。<br>また、2018 年 1 月 23 日時点で Private Fix が公開されておりますので、上記対処策の実施が難しい場合には Private Fix の適用についてご検討を頂ければと存じます。</p><h3 id="キャッシュの場所変更方法"><a href="#キャッシュの場所変更方法" class="headerlink" title="キャッシュの場所変更方法"></a>キャッシュの場所変更方法</h3><ol><li><p>タスク マネージャー (Ctrl + Shift + Esc キー) を起動し、[サービス] タグの「obengine (Microsoft Azure Recovery Services Agent)」を停止します。</p></li><li><p>現在のスクラッチ フォルダーのバックアップ対象ファイルやフォルダーを十分な空き容量のあるスクラッチ フォルダーへコピーします。<br>(規定 C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch)<br>   ↓<br>(例えば E:\Scratch など)</p></li><li><p>新しい Scratch フォルダーへ既定の Scratch フォルダー内にある OnlineBackup.KEK ファイルをコピーします。</p></li><li><p>レジストリ エディター (スタートボタン ＋ R キーし、「regedit」と入力) を起動し、以下設定を手順 2 と同じ場所に変更します。<br>レジストリ パス :<br>   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config<br>   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider</p><p>レジストリ キー :<br>ScratchLocation</p></li><li><p>バックアップを実行します。</p></li></ol><h2 id="■-参考"><a href="#■-参考" class="headerlink" title="■ 参考"></a>■ 参考</h2><p>Azure Backup サービスについての質問<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#backup" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#backup</a><br>参考箇所 : [バックアップ] の “Azure Backup エージェント用に指定されたキャッシュの場所を変更する方法を教えてください。”</p><h3 id="Private-Fix-適用方法について"><a href="#Private-Fix-適用方法について" class="headerlink" title="Private Fix 適用方法について"></a>Private Fix 適用方法について</h3><ol><li><p>タスク マネージャー (Ctrl + Shift + Esc キー) を起動し、[サービス] タグの「obengine (Microsoft Azure Recovery Services Agent)」を停止します。</p></li><li><p>Agent を最新の 2.0.9105.0 のバージョンにアップデートします。</p><ol><li>URL (<a href="https://aka.ms/azurebackup_agent" target="_blank" rel="noopener">https://aka.ms/azurebackup_agent</a>) より最新版の MARS エージェントをダウンロードします。 </li><li>ダウンロードした “MARSAgentInstaller.exe” を対象のサーバーで実行します。</li><li>更新プログラムをインストールするかの画面では [次へ] をクリックします。</li><li>インストールの画面で必要なソフトウェアのアップグレードをするかメッセージが表示されますので、[アップグレード] をクリックします。</li><li>アップグレードが完了した事を確認し [完了] をクリックします。</li></ol></li><li><p>下記からダウンロードした最新版の VhdFileProvider.dll ファイルを既存のものと置き換えます。<br><a href="http://blogs.technet.microsoft.com/jpaztech/2018/01/23/__trashed/vhdfileprovider/" target="_blank" rel="noopener">VhdFileProvider</a><br>既定のパス C：\Program Files\Microsoft Azure Recovery Services Agent\bin\VhdFileProvider.dll<br>※ 元々の VhdFileProvider.dll ファイルは任意の場所に保管をお願いします。</p></li><li><p>バックアップを実行します。<br>※ 最初のバックアップは下記メッセージが表示され失敗する可能性がございます。<br>※ これは、キャッシュ ロケーションを含むディスクのエラーが原因でございます。</p><blockquote><p>「バックアップが失敗しました。これは、Azure Backup が設定されたキャッシュ ロケーションでメタデータ vhd を準備できなかったためです。」</p></blockquote></li><li><p>別のバックアップをトリガーし、再度バックアップを取得します。</p></li></ol><h2 id="■-修正情報-2018-02-01-更新"><a href="#■-修正情報-2018-02-01-更新" class="headerlink" title="■ 修正情報 (2018/02/01 更新)"></a>■ 修正情報 (2018/02/01 更新)</h2><p><span style="color:red;">※ 2018/02/01  時点で最新版の MARS Agent (2.0.9109.0) が公開されました。</span></p><h3 id="最新版の-MARS-エージェントへのアップデート方法について"><a href="#最新版の-MARS-エージェントへのアップデート方法について" class="headerlink" title="最新版の MARS エージェントへのアップデート方法について"></a>最新版の MARS エージェントへのアップデート方法について</h3><ol><li>最新版の MARS エージェントをダウンロードします。</li><li>ダウンロードした “MARSAgentInstaller.exe” を対象のサーバーで実行します。</li><li>更新プログラムをインストールするかの画面では [次へ] をクリックします。</li><li>インストールの画面では必要なソフトウェアのアップグレードをするかのメッセージが表示されますので、[アップグレード] をクリックします。</li><li>アップグレードが完了した事を確認し [完了] をクリックします。</li></ol><p>以上でアップデートは完了です。</p><p>バックアップを実行時にエージェントのアップデートを実施した場合には、現在進行しているバックアップ処理はキャンセルされ、アップデート完了後、再度バックアップ処理が開始されます。尚、イベント ログ情報においてジョブの結果は失敗となります。</p><h3 id="※-注意点"><a href="#※-注意点" class="headerlink" title="※ 注意点"></a>※ 注意点</h3><ul><li>バックアップ操作または復元操作が実行中でないことを確認してください。実行中の操作はすべて取り消されます。</li><li>バックアップに使用される管理コンソールが閉じていることを確認してください。</li><li>実行中のレプリケーション操作は更新中にすべて取り消されます。これらの操作は、更新が完了すると再開されます。</li><li>スケジュールされたバックアップが、更新プログラムの適用中に実行された場合、バックアップ ジョブは失敗します。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;※ 2018/02/01 更新&lt;br&gt;修正版の MARS Agent が公開されましたので、更新方法を追記いたしました。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;こんにちは、Azure IaaS Support チームです。&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Azure Backup" scheme="https://jpaztech.github.io/tags/Azure-Backup/"/>
    
      <category term="MARS Agent" scheme="https://jpaztech.github.io/tags/MARS-Agent/"/>
    
  </entry>
  
  <entry>
    <title>2017/12/9 以降 Azure VM の起動に時間がかかる事象についての対処方法</title>
    <link href="https://jpaztech.github.io/archive/take-time-to-boot-after20171209/"/>
    <id>https://jpaztech.github.io/archive/take-time-to-boot-after20171209/</id>
    <published>2017-12-18T01:17:24.000Z</published>
    <updated>2019-10-17T11:18:44.258Z</updated>
    
    <content type="html"><![CDATA[<p><span style="color:red;">12/16 より問題解消のための修正を開始し、現在 (12/25) では修正を提供しております。<br>一部 VM に対しては別途ユーザー様に対処が必要な項目がございますので、継続して起動に時間がかかる問題が発生する環境においては、以下にご案内いたします対処実施をご検討ください。</span></p><h3 id="対象となる-VM-について"><a href="#対象となる-VM-について" class="headerlink" title="対象となる VM について"></a>対象となる VM について</h3><ul><li>VMSnapshot という名前の拡張機能がインストールされている VM(Azure バックアップの対象VM)</li><li>VM 停止状態においてバックアップが実行されているVM</li></ul><p>こんにちは、Azure IaaS Support チームです。<br>12/9 より一部の Azure VM にて起動処理に時間がかかる事象が発生しています。<br>このブログでは事象の発生理由と問題解消に向けた取り組みについて周知いたします。</p><h3 id="発生事象"><a href="#発生事象" class="headerlink" title="発生事象"></a>発生事象</h3><p>Azure ポータル・Azure PowerShell・Azure Automation を利用した VM が起動するまでに長時間かかります。<br>場合によっては VM の起動が失敗します。</p><h3 id="発生対象"><a href="#発生対象" class="headerlink" title="発生対象"></a>発生対象</h3><p>Azure バックアップの対象となっている Azure VM (Windows) で発生します。<br>具体的には、VMSnapshot という名前の拡張機能がインストールされている VM で発生します。<br>この拡張機能は Azure バックアップの対象としているサーバーに自動的にインストールされます。</p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>VM 起動処理の一環として拡張機能のステータスをチェックするステップがあります。<br>12/8 に実施された VMSnapshot 拡張機能の更新モジュールに問題があり、VM 起動時のステータス チェックが完了しない状態となっております。<br>その結果、VM の起動処理が完了するまでに長時間かかります。場合によっては VM の起動が失敗します。</p><h3 id="解消に向けた取り組み"><a href="#解消に向けた取り組み" class="headerlink" title="解消に向けた取り組み"></a>解消に向けた取り組み</h3><p>マイクロソフトではすでに原因を特定して、VMSnapshot 拡張機能の修正版を対象の VM に対して配信しております。</p><h3 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h3><p>本問題は最新版の拡張機能に更新する事で解決いたします。拡張機能の更新は VM が起動している際にバックアップを実行すると自動で行われます。尚、 VM 停止状態においてバックアップが実行される場合には更新が行われません。<br>その為、対処としてまずは問題が発生する環境の VMSnapshot の拡張機能を削除下さいますようお願いいたします。</p><h3 id="拡張機能の削除手順"><a href="#拡張機能の削除手順" class="headerlink" title="拡張機能の削除手順"></a>拡張機能の削除手順</h3><ol><li>Azure ポータルを開きます。</li><li>[Virtual Machines] - “対象の VM” - [拡張機能] - [VMSnapshot] を選択します。</li><li>[アンインストール] - [はい] を選択して拡張機能を削除します。</li></ol><p>上記作業を実施する事で、対象の VM の問題については修正されますが、対象のサブスクリプション上には複数の VM が存在しており、またいくつかの VM については停止状態でバックアップが実行される為、更新が行われない可能性がございます。<br>その為、以下のスクリプトを実行して対象のサブスクリプション上にあるすべての VM に対して VMSnapshot の拡張機能削除をご検討下さいますようお願いいたします。</p><p>VMSnapshot の拡張機能は次回バックアップを実行する際に再度インストールされますので、以下の削除を実施する事でのデメリットや VM への影響はございませんのでご安心ください。</p><p>———— スクリプト 開始 ————</p><pre>## Azure にログインします。Login-AzureRmAccount## すべての VM 情報を取得します。$VMs = Get-AzureRmVM## VM に VMSnapshot の拡張機能が含まれる場合には削除します。foreach($vm in $VMs){  Remove-AzureRmVMExtension -ResourceGroupName $vm.ResourceGroupName -VMName $vm.Name -Name VMSnapshot -Force}</pre><p>———— 実行結果例 ————</p><pre>RequestId IsSuccessStatusCode StatusCode ReasonPhrase--------- ------------------- ---------- ------------True      NoContent           No         Content  <<<< 対象の拡張機能がない場合に記録True                          OK         OK  <<<< 対象の拡張機能が削除された場合に記録Remove-AzureRmVMExtension : Cannot modify extensions in the VM when the VM is not running.ErrorCode: OperationNotAllowedErrorMessage: Cannot modify extensions in the VM when the VM is not running.<<<< VMが起動していない為拡張機能が削除出来ない場合に記録</pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;12/16 より問題解消のための修正を開始し、現在 (12/25) では修正を提供しております。&lt;br&gt;一部 VM に対しては別途ユーザー様に対処が必要な項目がございますので、継続して起動に時間がかかる問題が発生する環境にお
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Boot" scheme="https://jpaztech.github.io/tags/Boot/"/>
    
  </entry>
  
  <entry>
    <title>ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法</title>
    <link href="https://jpaztech.github.io/archive/monitor-io-throttoling-on-win-vm-arm/"/>
    <id>https://jpaztech.github.io/archive/monitor-io-throttoling-on-win-vm-arm/</id>
    <published>2017-10-04T01:23:55.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azureサポートチームの三國です。<br>今回は、ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法についてご案内いたします。</p><p>本記事は下記英文ブログの抄訳です。<br><a href="https://blogs.msdn.microsoft.com/mast/2017/09/12/how-to-monitor-and-alert-potential-disk-and-vm-level-io-throttling-on-windows-vms-using-arm/" target="_blank" rel="noopener">How to monitor and alert potential Disk and VM Level IO Throttling on Windows VMs using ARM</a><br><span style="color:gray;">本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</span></p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>本ブログはAzure上にあるWindows VMのディスクパフォーマンス監視手順について紹介します。<br>ディスクやVMレベルでのIOスロットリングについて検出することが目的です。<br>本ガイドラインはAzure Resource ManagerにてデプロイされているAzure上のすべてのバージョンのWindowsに適用できます。<br>手順の紹介に入る前に、3つの前提となる概念について説明します。</p><h3 id="スロットリングとは？"><a href="#スロットリングとは？" class="headerlink" title="スロットリングとは？"></a>スロットリングとは？</h3><p>Azure Premium Storage では、選択された VM サイズとディスク サイズに応じて、指定された数の IOPS とスループットがプロビジョニングされます。<br>アプリケーションが、VM またはディスクが対応できるこれらの上限を超えて IOPS やスループットを試みると、これを抑制するように調整されます。 これは、アプリケーションのパフォーマンスの低下という形で現れます。<br>これにより、待機時間が長くなり、スループットや IOPS が低下する可能性があります。<br>スロットリングにはディスクレベルと VM レベルの2種類があります。</p><p>詳細については以下のドキュメントをご確認下さい。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/premium-storage-performance#throttling" target="_blank" rel="noopener">Azure Premium Storage: 高パフォーマンス用に設計する - Throttling</a></p><h3 id="ディスク-レベルのスロットリングとは？"><a href="#ディスク-レベルのスロットリングとは？" class="headerlink" title="ディスク レベルのスロットリングとは？"></a>ディスク レベルのスロットリングとは？</h3><p>基本的に、ディスクの制限値を超えたIOについてはすべて滞留しより大きな遅延が発生します。<br>管理ディスク・非管理対象ディスクの制限値については以下のドキュメントをご参照ください。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/sizes-general#dsv2-series" target="_blank" rel="noopener">汎用仮想マシンのサイズ - DSv2 シリーズ</a></p><h3 id="VM-レベルのスロットリングとは？"><a href="#VM-レベルのスロットリングとは？" class="headerlink" title="VM レベルのスロットリングとは？"></a>VM レベルのスロットリングとは？</h3><p>基本的に、VM にアタッチされたディスクの総 IO がスループット制限を超えた場合に VM レベルのスロットリングが発生します。<br>制限値はキャッシュ/非キャッシュで異なります。<br>こちらは Premium ディスクをお使いの場合のみ該当します。<br>Standard ディスクをお使いの場合には VM レベルの IO スロットリングという概念はありません。</p><p>IOスロットリングの詳細については、以下のドキュメントをご参照ください。<br><a href="https://blogs.technet.microsoft.com/xiangwu/2017/05/14/azure-vm-storage-performance-and-throttling-demystify/" target="_blank" rel="noopener">Azure VM Storage Performance and Throttling Demystified</a></p><h2 id="準備"><a href="#準備" class="headerlink" title="準備"></a>準備</h2><p>本ブログの説明に用いるVMの構成例を以下に記載します。</p><p><strong>VM 名</strong>: “MonitorVM”<br><strong>VM サイズ</strong> : DS2_v2<br><strong>Disk 構成</strong>:<br>以下の4データディスクをVMにアタッチします:</p><ul><li>2x P10 (128 GB - Disk limits: 500 IOPS or 100 MB/s - Disk Cache Setting: None)</li><li>1x P20 (512 GB - Disk limits: 2300 IOPS or 150 MB/s - Disk Cache Setting: None)</li><li>1x P30 (1024 GB - Disk limits: 5000 IOPS or 200 MB/s - Disk Cache Setting: None)</li></ul><p>本シナリオでは、上記のようにアタッチされたディスクすべてについてキャッシュが無効になっています。<br>そのためVMの非キャッシュディスクスループット制限(IOPS/MBps)について確認します。<br>下記のURLの”キャッシュが無効な場合の最大ディスク スループット: IOPS/MBps”より確認できます。<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/sizes-general#dsv2-series" target="_blank" rel="noopener">汎用仮想マシンのサイズ - DSv2 シリーズ</a></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/01_dsv2_sizes.png"><p>キャッシュを有効にする場合は、上記 URL の”キャッシュが有効な場合の一時ストレージの最大スループット: IOPS/MBps (キャッシュ サイズは GiB 単位)”より VM における一時ストレージのスループット制限 (IOPS/MBps) を確認できます。</p><h2 id="“MonitorVM”VM内部のディスク設定の詳細について"><a href="#“MonitorVM”VM内部のディスク設定の詳細について" class="headerlink" title="“MonitorVM”VM内部のディスク設定の詳細について"></a>“MonitorVM”VM内部のディスク設定の詳細について</h2><p>F ドライブに、P10 ディスクを 2 つ用いて<a href="https://technet.microsoft.com/ja-jp/library/hh831739.aspx#BKMK_AZURE" target="_blank" rel="noopener">復元力を備えた記憶域</a>を構成し、1000 IOPS (2 x 500 IOPS) が制限値となります。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/02_storagespaces.png"><p><strong>ディスク管理:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/03_diskmanagement.png"><p><strong>ファイルエクスプローラー:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/04_explorer.png"><p><strong>“MonitorVM”VM内のパフォーマンスモニター:</strong></p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/05_perfmon.png"><p>VM 内のパフォーマンスモニターで VM の物理ディスクのパフォーマンスカウンターについてカウンター名が確認ができました。<br>次に、以下のパフォーマンスカウンターについて VM の診断設定に追加し、IOPS を Azure ポータルで監視する方法をご案内します。</p><p><strong>IOPS:</strong><br>“\PhysicalDisk(_Total)\Disk Transfers/sec” (VM レベルのスロットリング - 6400 IOPS)<br>“\PhysicalDisk(0 C:)\Disk Transfers/sec” (ディスクレベルのスロットリング - OS disk P10 - 500 IOPS)<br>“\PhysicalDisk(2)\Disk Transfers/sec” (ディスクレベルのスロットリング - P10 disk - 500 IOPS)<br>“\PhysicalDisk(3)\Disk Transfers/sec” (ディスクレベルのスロットリング - P10 disk - 500 IOPS)<br>“\PhysicalDisk(4 G:)\Disk Transfers/sec” (ディスクレベルのスロットリング - P20 disk - 2300 IOPS)<br>“\PhysicalDisk(5 H:)\Disk Transfers/sec” (ディスクレベルのスロットリング - P30 disk - 5000 IOPS)<br>“\PhysicalDisk(6 F:)\Disk Transfers/sec” (ディスクレベルのスロットリング - 記憶域スペースドライブ - 1000 IOPS)</p><h2 id="Azureポータルでパフォーマンスカウンターを監視するには？"><a href="#Azureポータルでパフォーマンスカウンターを監視するには？" class="headerlink" title="Azureポータルでパフォーマンスカウンターを監視するには？"></a>Azureポータルでパフォーマンスカウンターを監視するには？</h2><p>パフォーマンスカウンターはAzureポータルの診断設定にて追加できます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/06_perfcounterportal.png"><p>追加手順を以下に記載します。</p><ul><li>Azure ポータルの “MonitorVM” VM のページへ移動します</li><li>VM ブレードの “Diagnostic settings” を選択し、”Performance counter” タブへ移動します (図中 1.)</li><li>パフォーマンス カウンターを追加するため “Custom” (図中 2.) を選択します</li><li>テキスト ボックス (図中 3.) にパフォーマンス カウンター名を入力します (例: \PhysicalDisk(0 C:)\Disk Transfers/sec)</li><li>“Add” ボタン (図中 4.) を押下し、パフォーマンス カウンターを追加します</li><li>サンプル レートをテキスト ボックス内 (図中 5.) に入力します</li><li>最後に “Save” ボタンを押下し構成を保存します</li></ul><p>サンプル レートはパフォーマンス カウンターを収集する頻度です。<br>デフォルトでは 60 秒に指定されているため、60 秒ごとにパフォーマンス カウンターが収集されます。</p><p>ディスク負荷の変化が激しい場合は収集頻度を 10 秒、あるいは 1 秒に短縮して IO がディスクや VM の制限に到達していないかを確認できます。<br>ディスク負荷の変化が緩やかな場合はサンプル レートを大きくすることもできます。<br>サンプル レートはいつでも、すぐに変更でき、Azure ポータルの “Metrics” を通じて都度検証することができるので、ぜひ適切な値を環境に応じて調整してみてください。</p><h2 id="収集した情報を確認するには？"><a href="#収集した情報を確認するには？" class="headerlink" title="収集した情報を確認するには？"></a>収集した情報を確認するには？</h2><p>下図のようにAzureポータルの”Metrics”より確認ができます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/07_metricportal.png"><p>VMブレードの “metrics” へ移動すると、追加したパフォーマンス カウンターを選択し折れ線グラフで値を見ることができます。<br>右上にある”time range” を変更することで最近のデータについて見ることができます。</p><p>次に、”Add metric alert”より負荷が制限に達した際に通知を受ける方法をご案内します。</p><h2 id="“metric-alert-Rules”-を有効にするには？"><a href="#“metric-alert-Rules”-を有効にするには？" class="headerlink" title="“metric alert Rules” を有効にするには？"></a>“metric alert Rules” を有効にするには？</h2><p>下図はディスクレベルスロットリングを監視するための設定例です。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/08_ruleconfigdisk.png"><ul><li>“Metric” ドロップダウンより監視したいパフォーマンス カウンター (例では OS ディスク) を選択します</li><li>“Condition” ドロップダウンより “Greater than equal to” を選択します</li><li>“Threshold” に通知する IOPS の閾値 (例ではディスク レベルでの制限値、今回の場合は P10 ディスクの 500 IOPS) を入力します</li><li>“Period” で通知する閾値超えの期間 (例では 5 分以上) を選択します</li><li>メールで通知をする場合はチェックボックスをオンにし、必要に応じて “Additional administrator” を入力します</li><li>最後に、”Name” にルールの名前を入力し、”OK” を押下します</li></ul><p>その他のパフォーマンス カウンターについても同様のルールを作成します。<br>下図は VM レベルスロットリングを監視するための設定例です。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/09_ruleconfigVMIO.png"><p>“(_Total)” を含むカウンター名は VM レベルを監視するのに使用できます。</p><h2 id="“metrics-alert-Rues”をテストするには？"><a href="#“metrics-alert-Rues”をテストするには？" class="headerlink" title="“metrics alert Rues”をテストするには？"></a>“metrics alert Rues”をテストするには？</h2><p>今回、作成したルールをテストするのに <a href="https://github.com/Microsoft/diskspd" target="_blank" rel="noopener">diskspd</a> というベンチマークツールを用います。<br>以下のパラメータを用いて F ドライブに負荷をかけます (P10 disk を 2 つ用いた記憶域スペース)</p><blockquote><p>diskspd.exe -c1024M -d300 -W30 -w100 -t1 -o25 -b8k -r -h -L F:_diskSpd_test\testfile.dat</p></blockquote><p>下図に、負荷が制限値に達した記憶域スペースの様子を示します。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/10_storagespacesvmlimit.png"><p>上図より 2 つの P10 ディスクで 500 IOPS、F ドライブで 1000 IOPS の制限値に達していることがわかります。</p><p>続いて下図に、P30 disk に負荷をかけた後、VM レベルで制限値に到達させた様子を示します。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/11_iovmlimit.png"><p>上図ではまず P30 disk に 5000 IOPS の負荷をかけています。<br>その後、G ドライブ (P20) と H ドライブ (P30) に同時に負荷をかけ VM レベルの制限値 6400 IOPS に到達させています。<br>理論上、2 つのディスクの負荷上限は 7300 IOPS (P20 が 2300, P30 が 5000) ですが、VM の非キャッシュ スループットの上限は DS2_v2 の場合 6400 IOPS であることがわかります。</p><p>先述の “metric alert rule” で指定した閾値を超えた場合、メールにて通知されます。<br>下図は、VMレベルの制限値に達した際の通知メールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/12_notificationalertvmlimit.png"><p>下図は、VM レベルの制限値に達した後、事象が解決した際の通知メールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/13_notificationbelowlimit.png"><p><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-premium-storage-performance#nature-of-io-requests" target="_blank" rel="noopener">IO 要求の特性</a>により、たとえば 1 つ 1 つの IO サイズが大きい場合などに、IOP S制限値に到達していなくともスループットの制限値に到達することが起こりえます。<br>そのため以下の MBps についての監視も検討できます。</p><p>Throughput/MBps:<br>“\PhysicalDisk(_Total)\Disk Bytes/sec” (VM レベルのスロットリング - 96 MBps)<br>“\PhysicalDisk(0 C:)\Disk Bytes/sec” (ディスクレベルのスロットリング - OS disk P10 - 100 MBps)<br>“\PhysicalDisk(2)\Disk Bytes/sec” (ディスクレベルのスロットリング - P10 disk - 100 MBps)<br>“\PhysicalDisk(3)\Disk Bytes/sec” (ディスクレベルのスロットリング - P10 disk - 100 MBps)<br>“\PhysicalDisk(4 G:)\Disk Bytes/sec” (ディスクレベルのスロットリング - P20 disk - 150 MBps)<br>“\PhysicalDisk(5 H:)\Disk Bytes/sec” (ディスクレベルのスロットリング - P30 disk - 200 MBps)<br>“\PhysicalDisk(6 F:)\Disk Bytes/sec” (ディスクレベルのスロットリング - Storage Spaces Drive 2x P10 - 200 MBps)</p><p>今回の例においてスループットの制限値については、VM レベルよりディスク レベルのスロットリングの制限値が高いため、VM レベルについてのみ通知を設定すれば十分です。<br>ディスク レベルよりも高いスロットリングの制限値をもつ VM サイズ (DS4_v2 - 384 MBpsなど) を選択した場合は、ディスク/VM 両方のレベルで設定します。</p><p>下図はVMレベルでのMBpsの制限値超えを通知するルールです。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/14_rulembps.png"><p>負荷が最大 IOPS または MBps に達した際は、VM レベルでもディスク レベルでもスロットリングにより以下の 2 カウンターの値が増大します (例では OS ディスクについて記載しています)</p><p>“\PhysicalDisk(0 C:)\Current Disk Queue Length”?<br>“\PhysicalDisk(0 C:)\Avg. Disk sec/Transfer”?</p><h2 id="Metrics-データの保管場所について"><a href="#Metrics-データの保管場所について" class="headerlink" title="Metrics データの保管場所について"></a>Metrics データの保管場所について</h2><p>すべてのパフォーマンス カウンター Metric はストレージ アカウント内の “WADPerformanceCountersTable” に保管されます。<br>保管されるストレージアカウントは “Diagnostics settings” の “Agent” タブより確認できます。</p><img src="/blog/archive/monitor-io-throttoling-on-win-vm-arm/16_storageaccount.png"><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>本ブログではスロットリングを検知するためにストレージのパフォーマンスを監視・通知する手順についてご案内しました。<br>ディスクや VM レベルで制限値に達していないにもかかわらず VM の動作が遅くなっている場合は、切り分けとして <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/how-to-use-perfinsights" target="_blank" rel="noopener">PerInsights</a> を利用して調査を行うか、Azure サポートまでお問い合わせください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azureサポートチームの三國です。&lt;br&gt;今回は、ARMのWindowsでディスクやVMレベルでのIOスロットリングを監視・通知する方法についてご案内いたします。&lt;/p&gt;
&lt;p&gt;本記事は下記英文ブログの抄訳です。&lt;br&gt;&lt;a href=&quot;https://blo
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Monitoring / Alert" scheme="https://jpaztech.github.io/tags/Monitoring-Alert/"/>
    
      <category term="IO Throttling" scheme="https://jpaztech.github.io/tags/IO-Throttling/"/>
    
      <category term="Performance" scheme="https://jpaztech.github.io/tags/Performance/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway を PowerShell で設定変更するコツ</title>
    <link href="https://jpaztech.github.io/archive/powershell-applicationgateway-configuration/"/>
    <id>https://jpaztech.github.io/archive/powershell-applicationgateway-configuration/</id>
    <published>2017-09-07T06:28:25.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポートチームの飯塚です。</p><p>最近、おかげさまで Application Gateway をご利用いただいているお客様が増えております。以前は、ポータルからは Application Gateway の作成ができなかったため、手が出しにくいサービスの 1 つでしたが、現在はポータルから作成可能になり、より手軽に Application Gateway をご利用いただけるようになりました。</p><p>しかし、作成はできるようになりましたが、作成したあとの設定変更については、まだポータルからはできないことも多い状況です。ポータルから設定できる項目を増やすよう、弊社としましても取り組んでいるところですが、現状では、PowerShell 等での設定変更が必要な場面が少なからずあります。</p><p>ただし、PowerShell で Application Gateway を設定する手順は、慣れないと、少しわかりにくい側面がございます。実際にお問い合わせをいただくことも増えてまいりましたので、設定変更のコツを以下におまとめしました。少しでもお役に立てればと思います。<br>(なお、以下の内容はリソース マネージャー デプロイ モデルを対象としたものです)</p><h2 id="■-設定変更の流れ"><a href="#■-設定変更の流れ" class="headerlink" title="■ 設定変更の流れ"></a>■ 設定変更の流れ</h2><p>非常に簡単に説明しますと、PowerShell による Application Gateway の設定変更は、以下の流れで行います。</p><ol><li>Get する</li><li>設定変更する</li><li>Set する</li></ol><p>最初に現在の構成情報を変数に Get して、設定変更はその変数に対して行います。<br>そして最後に、設定変更した変数の内容を Set すれば、設定は完了という流れです。<br>時折、最後に Set するのを忘れてしまい、設定変更してエラーも出なかったのに反映されていない、というお問い合わせをいただくことがあります。<br>常に上記の 3 ステップを意識することが、非常に大切です。</p><h2 id="■-具体例-1-リスナーの削除"><a href="#■-具体例-1-リスナーの削除" class="headerlink" title="■ 具体例 (1) - リスナーの削除"></a>■ 具体例 (1) - リスナーの削除</h2><p>もう少し詳しく、具体的な例を交えて設定変更手順をみてみましょう。<br>以下に、「不要なリスナーを削除する」手順をご案内します。<br>ポータル上では新規のリスナーを作ったり、既存のリスナーの一覧を見ることはできますが、不要になったリスナーを削除することができません。</p><ol><li><p>$AppGw 変数に、既存の Application Gateway の設定を Get します。</p><blockquote><p>$AppGw = Get-AzureRmApplicationGateway -Name “AppGw の名前” -ResourceGroupName “AppGw が作成されているリソース グループ名”</p></blockquote></li><li><p>$AppGw 変数の内容から、対象のリスナーを削除します。</p><blockquote><p>Remove-AzureRmApplicationGatewayHttpListener -Name “削除するリスナー名” -ApplicationGateway $AppGw</p></blockquote></li><li><p>設定変更した $AppGw の内容を Set します。</p><blockquote><p>Set-AzureRmApplicationGateway -ApplicationGateway $AppGw</p></blockquote></li></ol><p>これで、リスナーの削除が完了です。2 つ目の手順を設定したい内容に応じて変更すれば、同じ流れでいろいろな設定変更ができます。</p><h2 id="■-具体例-2-SSL-オフロード用の証明書の変更"><a href="#■-具体例-2-SSL-オフロード用の証明書の変更" class="headerlink" title="■ 具体例 (2) - SSL オフロード用の証明書の変更"></a>■ 具体例 (2) - SSL オフロード用の証明書の変更</h2><p>もう 1 つ、具体例を紹介させていただきます。<br>お問い合わせいただく設定変更のうち、もっとも多いのは「SSL オフロード用の証明書の変更」です。<br>これも本日時点で、ポータルからできない設定変更です。</p><p>証明書の変更は、以下の手順で実行可能です。</p><ol><li><p>$AppGw 変数に、既存の Application Gateway の設定をGet します。</p><blockquote><p>$AppGw = Get-AzureRmApplicationGateway -Name “AppGw の名前” -ResourceGroupName “AppGw が作成されているリソース グループ名”</p></blockquote></li><li><p>$AppGw 変数に含まれる、証明書を更新します。</p><blockquote><p>Set-AzureRmApplicationGatewaySslCertificate -Name “既存の証明書の名前” -ApplicationGateway $AppGw -CertificateFile “新しい証明書 (pfx 形式) の絶対パス” -Password “SSL 証明書のパスフレーズ”<br>※ 証明書の絶対パスは、「C:\work\newcert.pfx」など、.pfx ファイルの場所を指定するものです。</p></blockquote></li><li><p>設定変更した $AppGw の内容を Set します。</p><blockquote><p>Set-AzureRmApplicationGateway -ApplicationGateway $AppGw</p></blockquote></li></ol><p>いかがでしょう？流れはリスナーの削除と一緒で、2 番目のコマンドが違うだけなのが、お分かりいただけると思います。</p><p>2 番目のコマンドは、実行する設定内容に応じて調べる必要があります。この記事ですべてを網羅するのは難しいため、コマンドリファレンスをご案内します。英語版しかなくて申し訳ありませんが、ぜひ参考にしてみてください (また、多くお問い合わせいただくものなどがあれば記事を更新しようと思います)。<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/azurerm.network/?view=azurermps-4.3.1#application_gateway" target="_blank" rel="noopener">AzureRm.Network - Application Gateway</a></p><h2 id="■-参考-Azure-PowerShell-の利用方法"><a href="#■-参考-Azure-PowerShell-の利用方法" class="headerlink" title="■ 参考 - Azure PowerShell の利用方法"></a>■ 参考 - Azure PowerShell の利用方法</h2><p>Azure PowerShell 自体のインストール方法については、以下の記事でご説明していますので、よろしければ、こちらも参考にご覧くださいませ。<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/05/02/azure-powershell-3-8-0-install/" target="_blank" rel="noopener">Azure PowerShell 最新版のインストール手順 (v3.8.0 現在) **追記あり</a></p><p>Azure PowerShell のインストール後に、実際に Azure の操作を行うためには (Application Gateway にかかわらず)、サインインが必要です。この手順についてのお問い合わせを何件かいただきましたので、以下に手順をご案内いたします。</p><ol><li>以下のコマンドを実行し、管理者アカウントでサインインします。<blockquote><p>Login-AzureRmAccount</p></blockquote></li><li>サブスクリプションが複数ある場合などは、念のため操作対象のサブスクリプションを明示的に指定します。<blockquote><p>Select-AzureRmSubscription -SubscriptionId “サブスクリプション ID”</p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポートチームの飯塚です。&lt;/p&gt;
&lt;p&gt;最近、おかげさまで Application Gateway をご利用いただいているお客様が増えております。以前は、ポータルからは Application Gateway の作成ができなかったため、手が出しにく
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/tags/Application-Gateway/"/>
    
      <category term="PowerShell" scheme="https://jpaztech.github.io/tags/PowerShell/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway で利用できる WAF について</title>
    <link href="https://jpaztech.github.io/archive/applicationgaetway-waf-01/"/>
    <id>https://jpaztech.github.io/archive/applicationgaetway-waf-01/</id>
    <published>2017-09-07T00:23:52.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは、Azure テクニカルサポートの平原です。<br>本日は、Application Gateway (以下 AppGW) で利用ができるようになった Web Application Firewall (以下 WAF) についてよくお問い合わせいただく内容についてご案内をいたします。</p><h2 id="■-WAF-でサポートされるルール"><a href="#■-WAF-でサポートされるルール" class="headerlink" title="■ WAF でサポートされるルール"></a>■ WAF でサポートされるルール</h2><p>2017 年 9 月現在、AppGW で利用できる WAF は、OWASP と呼ばれるオンライン上の国際的なオープン コミュニティで議論されている OWASP ModSecurity Core Rule Set (CRS) を採用しています。</p><p>利用できるものは、バージョン 2.2.9 および 3.0 になりますが、それ以外の WAF コンポーネント等は現状は利用はできません。<br>また、ご利用をいただくユーザーの方は、OWASP ModSecurity CRS の中で定義されているルールの中から、必要なものを選んでご利用をいただくこともできます。<br>他の WAF コンポーネント等の導入は未定ですが、必要に応じて、新しいバージョンの CRS セットや他の WAF コンポーネント等は導入されるかと思います。</p><p>CRS で定義されている各種ルールについては、主に Trustwave 社及び開発者有志により開発されていますが、各ルールに関する情報ファイルは GitHub にて公開をされているので、こちらをご参照ください。</p><p>OWASP ModSecurity Core Rule Set (CRS) Project (Official Repository)<br><a href="https://github.com/SpiderLabs/owasp-modsecurity-crs" target="_blank" rel="noopener">https://github.com/SpiderLabs/owasp-modsecurity-crs</a></p><p>また、各種 CRS については、OWASP コミュニティ上でプロジェクトとして議論を深められ開発・検討されています。<br>マイクロソフトサポートでは AppGW 上の正常動作に関するご質問等はお受けしていますが、OWASP 側で制定している CRS ルールに関して踏み入ったご相談やアドバイスに関するサポートは提供しておりません。(コンサルティングサポートなど一部上位のサポート契約でご相談いただける場合もあります)<br>もし各種 CRS ルールに関する詳細などを確認されたい場合には、関連するメーリングリスト等にご相談いただくか、直接 GitHub で公開されているソースコード等をご参照ください。</p><p>OWASP ModSecurity Core Rule Set Project<br><a href="https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project" target="_blank" rel="noopener">https://www.owasp.org/index.php/Category:OWASP_ModSecurity_Core_Rule_Set_Project</a></p><h2 id="■-留意点"><a href="#■-留意点" class="headerlink" title="■ 留意点"></a>■ 留意点</h2><ol><li><p>AppGW では、WAF 用の診断情報の収集が可能です。この診断情報を収集することで、ルールにより検知されたかどうかや、ブロックされたかどうかの確認が可能です。詳細については、以下をご参考ください。</p><ul><li>Application Gateway のバックエンドの正常性、診断ログ、およびメトリック</li><li><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-diagnostics" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-diagnostics</a></li><li>Azure で提供する Log Analytics (OMS) の機能と連携することで、収集されたデータを容易に検索することなどが可能になります。詳細は、Log Analytics のドキュメントをご参照ください。</li></ul></li><li><p>AppGW で WAF を利用の際には、パフォーマンスに気を付ける必要があります。<br>WAF は到達する各 HTTP/HTTPS リクエストごとに処理が行われるため、リクエストのサイズ等で処理が大きく変わってきます。<br>そのため、スループットの厳しい要件等がある場合には、利用にそぐわない場合もありますので、ご利用の際には十分ご検討いただき、必ず事前に実測データに近い形でパフォーマンスの検証を実施していただくことをお勧めします。</p><p>もし Web サイトを Azure 仮想マシン等でホストしている場合には、サードパーティ製の WAF によって、直接 Web サーバー (IIS や Apache など) に適用できる WAF コンポーネントもあります。<br>直接インストールをすることになるため、細かなカスタマイズも可能になる場合も多いので、もし必要がある場合はそちらもご検討ください。</p></li><li><p>AppGW 側の構成にて、適用できるルールは、カスタマイズができますが、OWASP Content Security Policy（CSP）の定義によって無効化などができず強制的に有効になるルールもあります。各種ルールの詳細につきましては、OWASP の各種定義をご参照ください。</p></li><li><p>AppGW で WAF を利用する場合には、AppGW 上のインスタンス サイズが M 以上のサイズが必要になります。<br>また、WAF に特化した料金になりますので、ご留意ください。<br>また、WAF が有効な場合に限りませんが、AppGW で SLA 適用の際には、2つ以上のインスタンスでの運用が必要になります。</p><ul><li>Application Gateway の価格</li><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/application-gateway/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/pricing/details/application-gateway/</a></li></ul></li></ol><p>以上、参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;皆さんこんにちは、Azure テクニカルサポートの平原です。&lt;br&gt;本日は、Application Gateway (以下 AppGW) で利用ができるようになった Web Application Firewall (以下 WAF) についてよくお問い合わせいただく内容につ
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>2017/10/31 に AzureBackup コンテナー (ASM) が、RecoveryServices コンテナー (ARM) にアップグレードされるお知らせ</title>
    <link href="https://jpaztech.github.io/archive/upgrade-backup-container-asm2arm/"/>
    <id>https://jpaztech.github.io/archive/upgrade-backup-container-asm2arm/</id>
    <published>2017-08-03T07:31:01.000Z</published>
    <updated>2019-10-17T11:18:44.258Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure IaaS Support チームです。</p><p>表題の通り、2017/10/31 に Azure Backup コンテナー (ASM) が、Recovery Services コンテナー (ARM) に自動でアップグレードされます。現在、このアナウンスを対象のユーザー様に電子メールにてお知らせしております。</p><img src="/blog/archive/upgrade-backup-container-asm2arm/0803.png"><p>これにより、今まで Azure Backup コンテナーにてバックアップを取得したデータは引き継げるのか心配されるかと存じます。<br>今回の自動アップグレードに関して、今までご利用のバックアップ データは問題なく、Recovery Services コンテナーに引き継がれ、そのデータ (2017/10/31 以前のデータ) より復元も可能ですのでご安心ください。</p><p>また、自動アップグレード後は今までご利用いただいたクラシック <a href="https://manage.windowsazure.com/" target="_blank" rel="noopener">Azure ポータル</a> ではなく、<a href="https://portal.azure.com/" target="_blank" rel="noopener">新 Azure ポータル</a> にてご利用いただくことになります。<br>尚、2017/10/31 の自動アップグレード前に手動でアップグレードいただくことも可能です。<br>以下、Azure Backup コンテナーから Recovery Services コンテナーへのアップグレードについて、参考となる弊社公開情報がございますのでぜひご参照ください。</p><h2 id="■-公開情報"><a href="#■-公開情報" class="headerlink" title="■ 公開情報"></a>■ 公開情報</h2><p>Upgrade classic Backup and Site Recovery vaults to ARM Recovery Services vaults<br>(クラシック Backup 及び Site Recovery 用のコンテナーを 新 Recovery Services コンテナーにアップグレードする)<br><a href="https://azure.microsoft.com/ja-jp/blog/upgrade-classic-backup-and-siterecovery-vault-to-arm-recovery-services-vault/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/blog/upgrade-classic-backup-and-siterecovery-vault-to-arm-recovery-services-vault/</a><br>参考箇所 : How to upgrade? (手動によるアップグレード方法)</p><p>Recovery Services コンテナーのアップグレードについて<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/07/13/recovery-services-コンテナーのアップグレードについて/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2017/07/13/recovery-services-コンテナーのアップグレードについて/</a></p><p>Recovery Services コンテナーのアップグレード (ASM -&gt; ARM) が可能になりました。<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/05/17/recovery-services-コンテナーのアップグレード-asm-arm-が可能にな/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2017/05/17/recovery-services-コンテナーのアップグレード-asm-arm-が可能にな/</a></p><p>※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure IaaS Support チームです。&lt;/p&gt;
&lt;p&gt;表題の通り、2017/10/31 に Azure Backup コンテナー (ASM) が、Recovery Services コンテナー (ARM) に自動でアップグレードされます。現在、このア
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Update / Upgrade" scheme="https://jpaztech.github.io/tags/Update-Upgrade/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway の構成について</title>
    <link href="https://jpaztech.github.io/archive/about-application-gateway/"/>
    <id>https://jpaztech.github.io/archive/about-application-gateway/</id>
    <published>2017-07-02T06:07:52.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<span style="color:red;">2019/2/27 追記Application Gateway で EV 証明書がサポートされるようになりましたので、FAQ の内容を更新しております。</span><p>こんにちは、Azure サポートチームの檜山です。<br>今回は Application Gateway の構成についてご紹介させていただきます。</p><p>また、下部に Application Gateway の FAQ もまとめてますので、ご参照ください。<br>Application Gateway はレイヤー 7 のロードバランサーで Web トラフィックを負荷分散することができますが、構成によっては設定が多岐にわたる場合があり、設定項目と実際の動作がイメージしにくいことがございます。<br>そのような時には、こちらのブログをご一読いただけますと幸いです。</p><p>Application Gateway の設定項目の概要と代表的な構成を以下に記載します。</p><ol><li><a href="#1">設定項目の概要</a></li><li><a href="#2">Basic 構成</a></li><li><a href="#3">マルチサイト</a></li><li><a href="#4">パスベースでの振り分け</a></li><li><a href="#5">マルチサイト&amp;パスベース</a></li><li><a href="#6">リダイレクト</a></li></ol><ul><li><a href="#7">FAQ</a></li></ul><p><span id="1"><span></span></span></p><h2 id="■-設定項目の概要"><a href="#■-設定項目の概要" class="headerlink" title="■ 設定項目の概要"></a>■ 設定項目の概要</h2><p>Application Gateway には主に以下の 7 つの設定項目があります。</p><img src="/blog/archive/about-application-gateway/setting.png"><ol><li><p><strong>構成</strong><br>Application Gateway の SKU サイズ、インスタンス数を指定可能です。<br><span style="color:red;">運用環境においては SKU サイズ M 以上、インスタンス数 2 以上が推奨となります。</span><br>インスタンス数が 1 の場合、メンテナンスや障害等で予期せず停止する場合がございますので、ご注意ください。</p></li><li><p><strong>Web アプリケーション ファイアウォール</strong><br>WAF の設定を行います。ファイアウォールのモードやルールの設定が可能です。<br>WAF については以下もご参照ください。<br><a href="https://jpaztech.github.io/blog/archive/application-gateway-waf-vulnerability-detection/">Application Gateway (WAF) での脆弱性検知について</a></p></li><li><p><strong>バックエンドプール</strong><br>リクエストを振り分ける先となるバックエンドの Web サーバーを設定します。<br>仮想マシン、IP アドレス、FQDN 等を指定することができます。 IP アドレス、FQDN については Azure 外部の Web サイトを設定することもできます。</p></li><li><p><strong>HTTP 設定</strong><br>バックエンドプールに接続する際のパラメーターを設定します。<br>バックエンドに接続するポートやプロトコル (http/https) 、カスタム プローブの指定などを行います。</p></li><li><p><strong>フロントエンド IP 構成</strong><br>Application Gateway がクライアントからリクエストを受け付けるためのパブリック IP アドレスまたはプライベート IP アドレスを設定します。<br>フロントエンド IP アドレスはパブリック IP, プライベート IP 共に最大 1 つずつです。</p></li><li><p><strong>リスナー</strong><br>Application Gateway がクライアントからリクエストを受け付けるためのフロントエンド IP の指定とフロントエンドのポート、プロトコル (http/https) を設定します。<br>https の場合、証明書の設定も行います。<br>マルチサイト リスナーを構成することでリクエストのホストヘッダに応じて負荷分散を行うことが可能です。</p></li><li><p><strong>ルール</strong><br>上記の “リスナー”、”バックエンドプール”、”HTTP 設定” の紐づけを行います。<br>パスベースのルールを構成することで、URL のパスに応じてバックエンド プールと HTTP 設定を変えることも可能です。<br>また、URL のリダイレクトを構成することもできます。</p></li><li><p><strong>正常性プローブ</strong><br>既定のプローブ以外のカスタム プローブを使用する場合に設定を行います。<br>カスタム プローブを構成することで、正常性プローブのホストヘッダやパスを指定することができます。</p></li></ol><p><span id="2"><span></span></span></p><h2 id="■-Basic-構成"><a href="#■-Basic-構成" class="headerlink" title="■ Basic 構成"></a>■ Basic 構成</h2><p>Azure Portal から作成した際の初期設定は Basic 構成となります。<br>このままでも利用可能ですが、次の項目に記載するマルチサイトやパスベース、リダイレクトの要件があった場合、ルールを追加または変更する必要があります。</p><p>以下の例は 2 つのルールが構成されています。<br>ルール 1 : https (443) で受け付けたリクエストを http (80) に SSL オフロードするルール<br>ルール 2 : http (80) で受け付けたリクエストをそのまま転送するルール</p><img src="/blog/archive/about-application-gateway/AppGW-Basic.png"><p><span id="3"><span></span></span></p><h2 id="■-マルチサイト"><a href="#■-マルチサイト" class="headerlink" title="■ マルチサイト"></a>■ マルチサイト</h2><p>マルチサイト リスナーを構成することで、クライアントがアクセスする URL のホスト名 (HTTP のホストヘッダ) に応じて振り分け先を変えることができます。<br>以下の例の動作をご説明します。</p><p>クライアントが “<a href="https://www.contoso.com&quot;" target="_blank" rel="noopener">https://www.contoso.com&quot;</a> にアクセスした場合、http (80) で Site1 にアクセスします。<br>クライアントが “<a href="https://www.fabrikam.com&quot;" target="_blank" rel="noopener">https://www.fabrikam.com&quot;</a> にアクセスした場合、 https (443) で Site2 にアクセスします。</p><img src="/blog/archive/about-application-gateway/AppGW-multisite2.png"><p><span style="color:red;">なお、ルールが複数構成されている場合、ルールは上から順 (先に作成されたもの順) に照合されます。<br>マルチサイト リスナーが含まれるルールと Basic リスナーが含まれるルールを両方構成する場合、マルチサイト リスナーが含まれるルールを先に作成することを推奨します。<br>Basic リスナーを含むルールを先に作成すると、マルチサイト リスナーが想定したとおりに動作しない可能性があります。</span></p><img src="/blog/archive/about-application-gateway/rule-priority1.png"><p><span id="4"><span></span></span></p><h2 id="■-パスベースでの振り分け"><a href="#■-パスベースでの振り分け" class="headerlink" title="■ パスベースでの振り分け"></a>■ パスベースでの振り分け</h2><p>パスベースのルールを作成することで URL のパスに応じて HTTP 設定やバックエンドを変更することができます。<br>以下の例の動作をご説明します。</p><p>クライアントが “<a href="https://xxxxx/&quot;" target="_blank" rel="noopener">https://xxxxx/&quot;</a> にアクセスした場合、http (80) で Site1 にアクセスします。<br>クライアントが “<a href="https://xxxxx/video/&quot;" target="_blank" rel="noopener">https://xxxxx/video/&quot;</a> にアクセスした場合、http (8080) で Site1 にアクセスします。<br>クライアントが “<a href="https://xxxxx/images/&quot;" target="_blank" rel="noopener">https://xxxxx/images/&quot;</a> にアクセスした場合、https (443) で Site2 にアクセスします。</p><img src="/blog/archive/about-application-gateway/AppGW-Pathbase.png"><p><span id="5"><span></span></span></p><h2 id="■-マルチサイト-amp-パスベース"><a href="#■-マルチサイト-amp-パスベース" class="headerlink" title="■ マルチサイト&amp;パスベース"></a>■ マルチサイト&amp;パスベース</h2><p>以下の様にマルチサイト リスナーとパスベースのルールを組み合わせて、URL のホスト名とパスに応じて HTTP 設定、バックエンドを変更することもできます。<br>以下の例の動作をご説明します。</p><p>クライアントが “<a href="https://www.contoso.com/&quot;" target="_blank" rel="noopener">https://www.contoso.com/&quot;</a> にアクセスした場合、http (80) で Site1 にアクセスします。<br>クライアントが “<a href="https://www.contoso.com/video/&quot;" target="_blank" rel="noopener">https://www.contoso.com/video/&quot;</a> にアクセスした場合、http (8080) で Site2 にアクセスします。<br>クライアントが “<a href="https://www.fabrikam.com/&quot;" target="_blank" rel="noopener">https://www.fabrikam.com/&quot;</a> にアクセスした場合、https (443) で Site3 にアクセスします。</p><img src="/blog/archive/about-application-gateway/AppGW-Multisite-Pathbase1.png"><p><span id="6"><span></span></span></p><h2 id="■-リダイレクト"><a href="#■-リダイレクト" class="headerlink" title="■ リダイレクト"></a>■ リダイレクト</h2><p>Application Gateway は受け取ったリクエストを他のリスナーや外部サイトにリダイレクトすることができます。<br>例えば http で受け付けたリクエストを https にリダイレクトすることも可能です。</p><p>以下の例の動作をご説明します。</p><p>【リダイレクトがリスナー 1 向けに構成されている場合】<br>クライアントが http (80) でアクセスしたリクエストを https (443) へリダイレクトします。</p><p>【リダイレクトが外部サイト向けに構成されている場合】<br>クライアントが http (80) でアクセスしたリクエストを “<a href="https://www.fabrikam.com&quot;" target="_blank" rel="noopener">https://www.fabrikam.com&quot;</a> へリダイレクトします。</p><img src="/blog/archive/about-application-gateway/AppGW-Redirect.png"><p><span id="7"><span></span></span></p><h2 id="■-FAQ"><a href="#■-FAQ" class="headerlink" title="■ FAQ"></a>■ FAQ</h2><p><span style="color:red;">以下の FAQ は V2 SKU ではない SKU (Standard, WAF) のApplication Gateway を対象に記載しておりますのでご留意ください。</span></p><ul><li><p><strong>Application Gateway のフロントエンド IP アドレス (パブリック) を固定 IP にできますか。</strong><br>フロントエンドのパブリック IP アドレスは動的な IP アドレスのみがサポートされております。<br>パブリック IP アドレスが変更されるタイミングは、Application Gateway を停止、再起動した場合、および Application Gateway 自体を削除し、再作成したタイミングとなります。<br>Azure 側のメンテナンス等で変更されることは想定されておりません。</p><p>パブリック IP アドレスの変更に対応する方法としては、フロントエンド IP アドレスに割り当たる DNS 名 (xxxx.cloudapp.azure.com) の CNAME エイリアスを構成することを推奨しております。<br>パブリック IP に割り当てられる DNS 名は、Application Gateway を停止、起動しても変更されることはございません。</p></li><li><p><strong>Application Gateway へ接続する接続元を制限することができますか。</strong><br>Application Gateway を配置する仮想ネットワークのサブネットにネットワーク セキュリティ グループ (NSG) を適用し、接続元を制限することができます。<br>NSG は FQDN での制限や地理的リージョンでの IP アドレス制限には対応しておりませんので、ご留意ください。</p><p>NSG のルールは以下を参照ください。<br>ネットワーク セキュリティ グループはアプリケーション ゲートウェイ サブネットでサポートされますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-faq#are-network-security-groups-supported-on-the-application-gateway-subnet" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/application-gateway/application-gateway-faq#are-network-security-groups-supported-on-the-application-gateway-subnet</a></p><p>Application Gateway へ接続すると 502 エラーが表示されます。<br>以下にも関連情報がございますので、ご確認ください。</p><p>Application Gateway における 502 Error について<br><a href="https://blogs.technet.microsoft.com/jpaztech/2018/03/16/application-gateway-502-error-info/" target="_blank" rel="noopener">https://blogs.technet.microsoft.com/jpaztech/2018/03/16/application-gateway-502-error-info/</a></p></li><li><p><strong>ラウンドロビンでの負荷分散は可能でしょうか。</strong><br>Application Gateway は既定でラウンドロビンで負荷分散が行われます。<br>ユーザーセッションを維持したい場合は HTTP 設定にて Cookie ベースのセッション アフィニティを有効化する必要があります。</p></li><li><p><strong>Sorry ページを構成することは可能でしょうか。</strong><br>以下のエラーページについてはカスタムのエラーページを構成することができます。</p><ul><li>HTTP 502（Bad Gateway)</li><li>HTTP 403（Forbidden）</li></ul><p>Application Gateway のカスタム エラー ページを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/application-gateway/custom-error" target="_blank" rel="noopener">https://docs.microsoft.com/ja-jp/azure/application-gateway/custom-error</a></p><p>ただし、カスタムエラーページは BLOB に配置された静的なサイトのみがサポートされています。</p></li><li><p><strong>EV 証明書を利用できますか。</strong><br>Application Gateway で EV 証明書はサポートされております。</p><p>What certificates are supported on Application Gateway?<br><a href="https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-faq#what-certificates-are-supported-on-application-gateway" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-faq#what-certificates-are-supported-on-application-gateway</a></p></li></ul><p>以上、参考になれば幸いです。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;span style=&quot;color:red;&quot;&gt;
2019/2/27 追記
Application Gateway で EV 証明書がサポートされるようになりましたので、FAQ の内容を更新しております。
&lt;/span&gt;


&lt;p&gt;こんにちは、Azure サポートチームの檜山で
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Application Gateway" scheme="https://jpaztech.github.io/tags/Application-Gateway/"/>
    
      <category term="WAF" scheme="https://jpaztech.github.io/tags/WAF/"/>
    
      <category term="Multisite" scheme="https://jpaztech.github.io/tags/Multisite/"/>
    
      <category term="Extended Validation Certificates" scheme="https://jpaztech.github.io/tags/Extended-Validation-Certificates/"/>
    
      <category term="Round Robin" scheme="https://jpaztech.github.io/tags/Round-Robin/"/>
    
  </entry>
  
  <entry>
    <title>1 TB 以上のディスクを持つ VM の Azure Backup (Private Preview)</title>
    <link href="https://jpaztech.github.io/archive/backup-morethan-1tb-disk/"/>
    <id>https://jpaztech.github.io/archive/backup-morethan-1tb-disk/</id>
    <published>2017-06-30T12:03:44.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームの世古です。<br>現在 Azure Storage において新しいディスク サイズが最大 4 TB までサポートされるようになりました。</p><p>2018/1/21 より管理ディスクを持つ VM においてもサポートされるようになりました。<br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/06/16/newazurestoragesizes/" target="_blank" rel="noopener">Azure Storage の新しいディスク サイズ – 4 TB までの VHD サイズがサポートされるようになりました。</a></p><p>12 月までは Azure IaaS VM のバックアップにおいては 4 TB のディスクを持つ VM のバックアップはサポートしておりませんでしたが、Azure Backup の機能追加により非管理ディスクのみ Private Preview として機能を提供しております。管理ディスクについては、1 月を目途に Private Preview の提供を進めております。<br><a href="https://gallery.technet.microsoft.com/Instant-recovery-point-and-25fe398a" target="_blank" rel="noopener">Instant recovery point and large disk support for Azure Backup</a></p><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ul><li>本プレビュー機能はサブスクリプション毎に適用されますので、適用したサブスクリプション内全ての Recovery Services コンテナーに本機能が反映されます。</li><li>本プレビュー機能をサブスクリプションに登録した場合、元に戻すことはできません。</li><li>プレミア ストレージを VM で使用している場合、初回バックアップ時に VM で使用している容量と同等の空き容量がストレージ アカウントに必要となります。</li><li>本プレビュー機能として、バックアップ時に作成されたスナップショットは「7 日間」保持される仕様となります。これは、リストアを高速化するための仕様となります。そのため、例えば 2 TB のディスク容量のスナップショットが既定で 7 日間保持されるため、その分ストレージ保持料金が発生します。(今後、保持期間を選択できるよう開発中です。 )</li></ul><h2 id="機能動作について"><a href="#機能動作について" class="headerlink" title="機能動作について"></a>機能動作について</h2><p>バックアップが実行されると、同じストレージ アカウント上に VM のスナップショットの情報が取得されます (以下図①)。<br>このスナップショットのデータは既定で 7 日間保持された後、Recovery Services コンテナー上にアップロードされます (以下図②)。</p><p>コンテナー上にアップロードされるまでの期間は 7 日間でございますが、コンテナー上にアップロードされたデータの保持期間はバックアップ時に指定頂いた保持期間でございます。</p><img src="/blog/archive/backup-morethan-1tb-disk/snapshot.jpg">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは、Azure サポート チームの世古です。&lt;br&gt;現在 Azure Storage において新しいディスク サイズが最大 4 TB までサポートされるようになりました。&lt;/p&gt;
&lt;p&gt;2018/1/21 より管理ディスクを持つ VM においてもサポートされるように
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Azure Backup" scheme="https://jpaztech.github.io/tags/Azure-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure PowerShell 最新版のインストール手順 (v3.8.0 現在) **追記あり</title>
    <link href="https://jpaztech.github.io/archive/azure-powershell-3-8-0-install/"/>
    <id>https://jpaztech.github.io/archive/azure-powershell-3-8-0-install/</id>
    <published>2017-05-02T06:07:49.000Z</published>
    <updated>2019-10-17T11:18:44.226Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><span style="color:red;">2017 年 9 月 5 日 追記</span><br>下記の記事の執筆以降も Azure PowerShell は更新されており、現在の最新バージョン (4.3.1) では、スタンドアローンのインストーラーも公開されております。以下のページの「Azure PowerShell 4.3.1 Installer」から、インストーラーをダウンロードして実行すれば、この記事の手順を行わなくても Azure PowerShell のインストールは可能です。</p><p><span style="color:red;">Releases - Azure/azure-powershell</span></p><p>ただし、この記事の手順でインストールを実行すると、アップデートがしやすいなどのメリットもありますので、こちらの手順についても、ぜひ参考にしていただければと思います。</p></blockquote><p>こんにちは、Azure サポートチームの飯塚です。</p><p>コマンドやスクリプトで Azure の管理ができる、とっても便利な Azure PowerShell ですが、ここ最近のバージョンにおいて、スタンドアローンのインストーラーが提供されなくなったり、WebPI でのインストールができなくなっているなど、インストール方法が少々変わっております。</p><p>2017 年 5 月 2 日時点での最新版である Azure PowerShell 3.8.0 のインストール手順は、以下の公開ドキュメントでご説明しているとおり、PowerShellGet を利用するものです。<br><a href="https://docs.microsoft.com/ja-jp/powershell/azure/install-azurerm-ps" target="_blank" rel="noopener">Install and configure Azure PowerShell</a></p><p>しかし、本ドキュメントは現時点で英語版のみの提供であり、また PowerShellGet のインストールなど、一部別のドキュメントの参照が必要な部分もあり、少々わかりにくいのではないかと思います。そこで、本ブログ記事で、あらためて Azure PowerShell のインストール方法をおまとめしました。参考にしていただければと思います。</p><h2 id="■-1-PowerShellGet-のインストール"><a href="#■-1-PowerShellGet-のインストール" class="headerlink" title="■ 1. PowerShellGet のインストール"></a>■ 1. PowerShellGet のインストール</h2><p>Azure PowerShell の最新版のインストールは、PowerShellGet という、PowerShell コマンドで自動的にモジュールをダウンロードする仕組みを利用します。<br>PowerShellGet は、Windows 10 か Windows Server 2016 以降のコンピューターには、PowerShell 5.0 とともに既定でインストールされています。</p><p>お手元のコンピューターで、PowerShellGet が使えるかどうかを確認するには、以下の PowerShell コマンドを実行します。</p><p><strong>コマンド</strong></p><blockquote><p>Get-Module PowerShellGet -list | Select-Object Name,Version,Path</p></blockquote><p><strong>PowerShellGet が使える場合の出力例</strong></p><blockquote><p>Name          Version Path</p><hr><p>PowerShellGet 1.0.0.1 C:\Program Files\WindowsPowerShell\Modules\PowerShellGet\1.0.0.1\PowerShellGet.psd1</p></blockquote><p>コマンドの出力結果に、PowerShellGet のバージョン情報が出力されれば、PowerShellGet が使えますので、そのまま 2. の手順に進んでください。<br>もし表示されない場合 (PowerShellGet が使えない場合、画面になにも出力されないはずです) は、以下のいずれかの手順で PowerShellGet をインストールしてください。</p><h3 id="1-1-PowerShell-5-0-へのアップグレード"><a href="#1-1-PowerShell-5-0-へのアップグレード" class="headerlink" title="1-1. PowerShell 5.0 へのアップグレード"></a>1-1. PowerShell 5.0 へのアップグレード</h3><p>PowerShell 自体を 5.0 にアップグレードする方法です。<br>以下のページから Windows Management Framework 5.0 をダウンロードし、PowerShell 5.0 をインストールします。<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=50395" target="_blank" rel="noopener">Windows Management Framework 5.0</a></p><h3 id="1-2-PowerShellGet-のみのインストール"><a href="#1-2-PowerShellGet-のみのインストール" class="headerlink" title="1-2. PowerShellGet のみのインストール"></a>1-2. PowerShellGet のみのインストール</h3><p>PowerShellGet の機能をインストールするものです。以下のページからモジュールをダウンロードし、インストールします。<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=51451" target="_blank" rel="noopener">PackageManagement PowerShell Modules Preview - March 2016</a></p><h2 id="■-2-Azure-PowerShell-のインストール"><a href="#■-2-Azure-PowerShell-のインストール" class="headerlink" title="■ 2. Azure PowerShell のインストール"></a>■ 2. Azure PowerShell のインストール</h2><p>PowerShellGet が利用できるようなっしたら、実際に Azure PowerShell をインストールします。<br>PowerShell を「管理者として実行」して、以下のコマンドを実行してください。<br>クラシック デプロイ モデルとリソース マネージャー デプロイ モデルで、それぞれインストールするモジュール名が異なりますが、2 つのモジュールは共存可能ですので、両方のコマンドを実行いただいても問題ありません。</p><p><strong>クラシック デプロイ モデルの Azure PowerShell をインストール</strong></p><blockquote><p>Install-Module Azure<br><strong>リソース マネージャー デプロイ モデルの Azure PowerShell のインストール</strong><br>Install-Module AzureRM</p></blockquote><p>コマンドの実行時に、必要なモジュールをインストールするか尋ねられた場合は「Y」を入力して先に進みます。</p><blockquote><p><span style="color:red;">2017 年 9 月 5 日 追記</span><br>最新の Azure PowerShell にバージョンアップする場合は、<span style="color:red;">Update-Module</span> コマンドがご利用いただけます。</p></blockquote><ol start="3"><li>Azure PowerShell の利用<br>実際に Azure PowerShell のコマンドレットを利用する場合、最初に、以下のコマンドを実行してモジュールのロードを行ってください。</li></ol><p>クラシック デプロイ モデルの Azure PowerShell をインポート<br>Import-Module Azure<br>リソース マネージャー デプロイ モデルの Azure PowerShell のインポート<br>Import-Module AzureRM<br>補足: 自動的に Import-Module が実行されるようにする方法<br>PowerShell を起動するたびに、Import-Module コマンドを実行するのは面倒かもしれません。そのようなときは、「PowerShell プロファイル」に Import-Module コマンドを記載することで、PowerShell の実行時に、自動的に Import-Module コマンドが実行され、すぐに Azure PowerShell が利用できるようになります。</p><p>PowerShell プロファイルについては、以下の資料を参考にご覧ください。</p><p>Windows PowerShell プロファイル</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;&lt;span style=&quot;color:red;&quot;&gt;2017 年 9 月 5 日 追記&lt;/span&gt;&lt;br&gt;下記の記事の執筆以降も Azure PowerShell は更新されており、現在の最新バージョン (4.3.1) では、スタンドアローンのイン
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="PowerShell" scheme="https://jpaztech.github.io/tags/PowerShell/"/>
    
  </entry>
  
  <entry>
    <title>ARM 環境から ARM 環境への仮想マシンの移行方法</title>
    <link href="https://jpaztech.github.io/archive/migration_arm_to_arm/"/>
    <id>https://jpaztech.github.io/archive/migration_arm_to_arm/</id>
    <published>2016-11-07T09:42:09.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azureサポートチームの小久保です。<br>本日は、別のサブスクリプションの環境に仮想ネットワーク、仮想マシンを移行する方法をご紹介します。<br>今回、ご紹介する環境は、Azure リソース マネージャー (以下、ARM) 環境から ARM 環境への移行となっております。</p><h2 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h2><p>Azure サービス マネージャー (以下、ASM) 環境から ASM 環境への移行の場合は以下をご確認ください。<br><a href="http://blogs.technet.microsoft.com/jpaztech/2016/07/11/migration_classic_to_classic/" target="_blank" rel="noopener">クラシック環境からクラシック環境への仮想マシンの移行方法</a></p><h2 id="利用する場面"><a href="#利用する場面" class="headerlink" title="利用する場面"></a>利用する場面</h2><ul><li>開発用のサブスクリプションで作成した仮想マシンを本番環境用のサブスクリプションへ移行したい。</li><li>VHD の保存されているストレージ アカウントを移動したい。</li><li>ストレージ アカウントをプレミアム ストレージに変更したい。</li></ul><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ul><li>移行を前提としているため、一般化していない (特殊化状態の) 仮想マシンのシナリオをご紹介します。</li></ul><h2 id="構成と作業の流れ"><a href="#構成と作業の流れ" class="headerlink" title="構成と作業の流れ"></a>構成と作業の流れ</h2><ol><li>仮想マシンの停止</li><li>移行先のサブスクリプションに、ストレージアカウントおよびコンテナーの作成</li><li>移行先のサブスクリプションに、仮想ネットワークの作成</li><li>AzCopyにて、OS ディスク、データディスクの VHDファイルの移行<br>※ データディスクが存在しない場合は、OS ディスクのみ移行します。</li><li>移行した OS ディスクより、仮想マシンの作成</li></ol><img src="/blog/archive/migration_arm_to_arm/Constitution3.png"><h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>AzCopy ツールを利用するため、 Microsoft Azure Storage Tools を以下よりダウンロードし、お手元のコンピューターにインストールをお願いします。<br><a href="https://aka.ms/downloadazcopy" target="_blank" rel="noopener">Microsoft Azure Storage Tools</a></p><h2 id="作業手順"><a href="#作業手順" class="headerlink" title="作業手順"></a>作業手順</h2><h3 id="1-新-ポータル-https-portal-azure-com-より、仮想マシンを停止します。"><a href="#1-新-ポータル-https-portal-azure-com-より、仮想マシンを停止します。" class="headerlink" title="1. 新 ポータル (https://portal.azure.com/) より、仮想マシンを停止します。"></a>1. 新 ポータル (<a href="https://portal.azure.com/" target="_blank" rel="noopener">https://portal.azure.com/</a>) より、仮想マシンを停止します。</h3><img src="/blog/archive/migration_arm_to_arm/stopvm.png"><h3 id="2-移行先のサブスクリプションに、ストレージアカウントを作成します。"><a href="#2-移行先のサブスクリプションに、ストレージアカウントを作成します。" class="headerlink" title="2. 移行先のサブスクリプションに、ストレージアカウントを作成します。"></a>2. 移行先のサブスクリプションに、ストレージアカウントを作成します。</h3><p>ストレージ アカウントを選択後、[＋追加] をクリックします。</p><img src="/blog/archive/migration_arm_to_arm/addstorage.png"><p>新規作成するストレージアカウントの情報を入力し、「作成」ボタンをクリックします。<br><span style="color:red;">※ アカウントの種類は汎用を選択します。</span><br>※ サブスクリプションは移行先のサブスクリプションを選択します。</p><img src="/blog/archive/migration_arm_to_arm/addstorageproperty2.png"><h3 id="3-移行先のサブスクリプションに、仮想ネットワークを作成します。"><a href="#3-移行先のサブスクリプションに、仮想ネットワークを作成します。" class="headerlink" title="3. 移行先のサブスクリプションに、仮想ネットワークを作成します。"></a>3. 移行先のサブスクリプションに、仮想ネットワークを作成します。</h3><p>仮想ネットワークを選択後、[＋追加] をクリックします。</p><img src="/blog/archive/migration_arm_to_arm/addvnet.png"><p>新規作成する仮想ネットワークの情報を入力し、「作成」ボタンをクリックします。<br><span style="color:red;">※サブスクリプションは移行先のサブスクリプションを選択します。</span></p><img src="/blog/archive/migration_arm_to_arm/addvnetproperty2.png"><h3 id="4-AzCopy-を利用し、移行先のストレージアカウントへ-VHD-ファイルをコピーします。"><a href="#4-AzCopy-を利用し、移行先のストレージアカウントへ-VHD-ファイルをコピーします。" class="headerlink" title="4. AzCopy を利用し、移行先のストレージアカウントへ VHD ファイルをコピーします。"></a>4. AzCopy を利用し、移行先のストレージアカウントへ VHD ファイルをコピーします。</h3><p>管理者権限にてコマンドプロンプトを起動し、AzCopy のディレクトリに移動し、AzCopy コマンドを実行します。<br><span style="color:red;">※ 同じデータセンター内での VHD ファイルの移動は無償ですが、データセンターを跨いだ VHD ファイルの移動は有償となります為、ご注意ください。</span></p><p>コマンド例：</p><blockquote><p>cd C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy</p></blockquote><p>コマンド基本構文：</p><blockquote><p>azcopy.exe /source:＜コピー元コンテナーの URL＞ /dest:＜コピー先コンテナーの URL＞ /SourceKey:＜コピー元ストレージ アカウントのアクセス キー＞ /destKey:＜コピー先ストレージ アカウントのアクセス キー＞ /pattern:”＜VHD ファイル名＞.vhd”</p></blockquote><p>※ コンテナーの URL は [ストレージアカウント] ー＞ [概要] ー＞ [BLOB] ー＞ コンテナーの・・・を右クリックし、[プロパティ]よりご確認ください。</p><img src="/blog/archive/migration_arm_to_arm/VHD_URL2.png"><p>※ アクセスキーは [ストレージアカウント] ー＞ [アクセスキー] よりご確認ください。</p><img src="/blog/archive/migration_arm_to_arm/accesskeynew.png"><p>※ VHD ファイル名は、コピー元のファイル名をご指定ください。</p><p>AzCopy の利用方法については、以下の記事もご参照ください。</p><ul><li><a href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-use-azcopy/" target="_blank" rel="noopener">AzCopy コマンド ライン ユーティリティを使用してデータを転送する</a></li><li><a href="http://blogs.technet.com/b/ksasaki/archive/2012/11/09/azcopy-blob.aspx" target="_blank" rel="noopener">azcopy – BLOB へファイルをやったり取ったり</a></li></ul><h3 id="5-コピーした-VHD-ファイルをもとに、Azure-PowerShell-を使用して、仮想マシンを作成します。"><a href="#5-コピーした-VHD-ファイルをもとに、Azure-PowerShell-を使用して、仮想マシンを作成します。" class="headerlink" title="5. コピーした VHD ファイルをもとに、Azure PowerShell を使用して、仮想マシンを作成します。"></a>5. コピーした VHD ファイルをもとに、Azure PowerShell を使用して、仮想マシンを作成します。</h3><p>特殊化 VHD ファイルから仮想マシンを ARM 環境にデプロイする為の Azure PowerShell は以下ブログにて、公開しております。<br><br><a href="https://blogs.technet.microsoft.com/jpaztech/2017/05/24/deployfromspecializedvhd-powershell/" target="_blank" rel="noopener">特殊化 VHD ファイルから ARM 環境へ仮想マシンをデプロイする Azure PowerShell</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。Azureサポートチームの小久保です。&lt;br&gt;本日は、別のサブスクリプションの環境に仮想ネットワーク、仮想マシンを移行する方法をご紹介します。&lt;br&gt;今回、ご紹介する環境は、Azure リソース マネージャー (以下、ARM) 環境から ARM 環境への移行とな
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Migration" scheme="https://jpaztech.github.io/tags/Migration/"/>
    
      <category term="ARM" scheme="https://jpaztech.github.io/tags/ARM/"/>
    
  </entry>
  
  <entry>
    <title>2016 年 9 月 15 日に発生した DNS の問題について</title>
    <link href="https://jpaztech.github.io/archive/dns-2016-09-16/"/>
    <id>https://jpaztech.github.io/archive/dns-2016-09-16/</id>
    <published>2016-09-16T09:41:18.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>本ポストは 2016 年 9 月 15 日に発生した DNS の問題の日本語抄訳です。正式な文章は英語となりますので、下記を必要に応じてご参照ください。<br><span style="color:red;">※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点 (9/20 10:00) でのものであり、予告なく変更される場合があります。</span></p><p>公開情報: Azure の状態の履歴<br><a href="https://azure.microsoft.com/ja-jp/status/history/" target="_blank" rel="noopener">https://azure.microsoft.com/ja-jp/status/history/</a></p><h2 id="■-概要"><a href="#■-概要" class="headerlink" title="■ 概要"></a>■ 概要</h2><p>日本時間 9 月 15 日のおおよそ午後 8:18 から翌日午前 2:15 の間に、Microsoft Azure のサービスをご利用の一部のお客様から、接続不可などのサービス低下に関するご報告をいただきました。この問題は、Microsoft Azure のデータセンターで使用しているネットワーク機器上のソフトウェアの不具合により発生しておりました。この不具合により、ネットワークトラフィックの高負荷を適切に処理できず、通常の DNS 名前解決要求が不正なものとして処理されてしまい、弊社 Azure のサービスおよびリソースの名前解決に影響を及ぼしていました。</p><p>該当のソフトウェアの不具合を回避するための設定変更を行い、日本時間 9 月 15 日のおおよそ午後 10 時には、展開した回避策の効果があったことが確認されています。</p><p>DNS が復旧したこのタイミングで、それに依存するほぼすべてのサービスが復旧しましたが、米国中部リージョンにおいては、Azure SQL Database および SQL Data Warehouse、さらにそれらに依存する HDInsight や Media Services 等の一部のサービスにおいて、その後もサービス低下に関する事象が継続しておりました。</p><p>これは、DNS 名前解決要求の問題の解消後、Azure SQL Database サービスが処理できないような予期しない多量の再接続要求が発生したことによるものでした。Azure SQL Database サービスは、お客様からの多くにリクエストをすばやく、スムーズに処理できましたが、米国中部リージョンでは処理がうまくいきませんでした。米国中部リージョンの Azure SQL Database では、想定よりも高い割合でリクエストによって負荷がかかり、Azure SQL Database サービスの可用性に影響を及ぼしました。すぐに、Azure SQL Database サービスチームが対処に当たり、復旧を妨げている高負荷のリクエストを特定しました。当該チームは、Azure SQL Database サービスへのリクエストの量をコントロールし、処理がスムーズに進むように調整し、すべてのリクエストが通常通り処理されることを確認いたしました。この問題は、翌日 9 月 16 日 の午前 2:15 頃、Azure SQL Database サービスへの接続要求を調整することで、その他関連するサービス (HDInsight や Media Services) を含めた復旧が確認できています。</p><h3 id="発生時刻"><a href="#発生時刻" class="headerlink" title="発生時刻"></a>発生時刻</h3><p>2016 年 9 月 15 日 20:18 (日本標準時)</p><h3 id="復旧時刻"><a href="#復旧時刻" class="headerlink" title="復旧時刻"></a>復旧時刻</h3><p>DNS の復旧 : 2016 年 9 月 15 日午後 10:00 (日本標準時)<br>SQL Database (米国中部) の復旧 : 2016 年 9 月 16 日 午前 2:15 (日本標準時)</p><h3 id="影響範囲"><a href="#影響範囲" class="headerlink" title="影響範囲"></a>影響範囲</h3><p>次の Microsoft Azure に関連するサービスをご利用の一部のお客様から、DNS の問題の影響で接続不可などのサービス低下がございました。</p><ul><li>App Service/Web Apps</li><li>Service Bus</li><li>Redis Cache</li><li>Azure Backup</li><li>Visual Studio Team Services</li><li>Azure Media Services</li><li>Azure Search</li><li>SQL Database</li><li>HD Insight</li><li>Application Insight</li><li>IotHub</li><li>AzureLog Analytics</li><li>Azure Automation</li><li>DataMovement</li></ul><p>問題に影響が出ていた Azure SQL Database 、Data Warehouse、HDInsight および Media Services の可用性については、DNS の問題により、およそ 60% 程度の可用性の低下があったと推測されます。DNS の問題が復旧したのちに、米国中部の SQL Database および Data Warehouse、およびそれに依存するサービスをご利用の一部のお客様で継続して影響が発生し続けました。</p><h3 id="影響があった地域"><a href="#影響があった地域" class="headerlink" title="影響があった地域"></a>影響があった地域</h3><p>全てのリージョン</p><h2 id="■-原因"><a href="#■-原因" class="headerlink" title="■ 原因"></a>■ 原因</h2><p>Microsoft Azure のデータセンターで使用されているネットワーク機器のソフトウェア不具合により、ネットワークトラフィックの高負荷を適切に処理できない問題が発生していました。その結果、通常の DNS 名前解決要求が不正なものとして処理されることがあり、弊社 Azure のサービスおよびリソースの名前解決に影響を及ぼしました。</p><p>米国中部リージョンにおいては、復旧後の再接続要求が予想以上に多く、負荷の問題により Azure SQL Database や SQL Data Warehouse、および、それらに依存する一部のサービスにおいて引き続きサービス低下の提供が発生していました。</p><p>Azure SQL Database と Data Warehouse およびそれを利用するお客様は、DNS を利用しています。このため、Azure SQL Database と Data Warehouse へ接続するには、2 回にわたり DNS ルックアップが必要になります。すべての Azure SQL Database と Data Warehouse の接続リクエストは、まず、コントロールリング と呼ばれる、Azure ホストサービスで処理されます。これは、DNS レコードで <servername>.database.windows.net で参照される IP アドレスに紐づけられています。コントロールリングは、どの Azure ホストサービスが現在、リクエスト対象のデータベース/データウェアハウスをホストしているかをトラックし、呼び出し元に対してサービスへの DNS 名を返します。これは、<instance name>.<ring number>.<regionname>.worker.database.windows.net の形式です。呼び出し元は、再度、その場所に対して DNS ルックアップを実行します。(Azure 外部からの接続をしている) 一部のお客様では、コントロールプレーンが代理ですべての接続を実施し、DNS ルックアップも実施していました。データベースとデータウェアハウスに対する内部からの接続については、例えば、サービス管理操作や地理冗長トランザクションなどがありましたが、それらも、他のデータベース・データウェアハウスへの呼び出し元として機能し、それらも、同時に 2 回の DNS ルックアップを必要としました。障害の間の接続で、これらをすべて評価すると、azure SQL Database および Data Warehouse に対して、およそ 75% の割合で DNS ルックアップが失敗し、1回の試行で、当時、およそ 6% の接続が成功していたことを意味します。</regionname></ring></instance></servername></p><h2 id="■-今後の対応"><a href="#■-今後の対応" class="headerlink" title="■ 今後の対応"></a>■ 今後の対応</h2><p>今後、このような問題が発生することのないよう、Microsoft Azureプラットフォームおよびプロセスの改善に努めてまいります。本件につきましては、特に以下の点について対応を実施いたします。</p><ul><li>今回の事象の原因となったネットワーク機器のソフトウェア不具合を解消する修正について検証を行い、テストが完了次第展開を行います。(現在作業中)</li><li>DNS のサービス低下を早期に検出できるよう監視の仕組みを強化し、ダウンタイムを最小限にとどめます。(現在作業中)</li><li>ネットワーク機器のソフトウェアの不具合を回避する新しい設定を展開しました。(完了済み)</li><li>Azure SQL Database や SQL Data Warehouse について、DNS レコードの TTL の値を見直し、名前解決に影響があった場合の影響を軽減します。(現在作業中)</li></ul><h3 id="9-27-変更箇所"><a href="#9-27-変更箇所" class="headerlink" title="9/27 変更箇所　　"></a>9/27 変更箇所　　</h3><ul><li>まずは今回の障害で影響を受けたSQL Databaseを利用しているAzureのサービスがこのような障害が発生しても最小限のダウンタイムでサービスを継続してご提供できるように、サービスとしての復旧体制の見直しと改善を行います。また、このような障害が発生した際に、ダウンタイムを最小限にすることができるような手段をお客様にご提供できるよう検討・改善を引き続き行っていきます。</li></ul><p>今回の障害では貴社に多大なご迷惑をおかけしましたことを、改めて心よりお詫び申し上げます。Microsoft Azure のさらなる改善へ向け引き続き努力をしてまいりますので、今後とも何卒宜しくお願い申し上げます。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本ポストは 2016 年 9 月 15 日に発生した DNS の問題の日本語抄訳です。正式な文章は英語となりますので、下記を必要に応じてご参照ください。&lt;br&gt;&lt;span style=&quot;color:red;&quot;&gt;※ 本情報の内容（添付文書、リンク先などを含む）は、作成日時点 
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="DNS" scheme="https://jpaztech.github.io/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>’azurebox32.ico’ が必要です</title>
    <link href="https://jpaztech.github.io/archive/need-azurebox32-ico/"/>
    <id>https://jpaztech.github.io/archive/need-azurebox32-ico/</id>
    <published>2016-03-30T11:58:32.000Z</published>
    <updated>2019-10-17T11:18:44.242Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートチームの比留間です。</p><p>今回は、Azure 仮想ネットワークに対するポイント対サイト接続用のクライアント パッケージをインストールする際に、”‘azurebox32.ico’が必要です。” という文言のエラーが発生する事象についてお話させていただきます。</p><img src="/blog/archive/need-azurebox32-ico/capture.png"><h2 id="■-現象の発生条件について："><a href="#■-現象の発生条件について：" class="headerlink" title="■ 現象の発生条件について："></a>■ 現象の発生条件について：</h2><p>現時点で、この事象は、ユーザープロファイルのパス名に、日本語を含む環境において発生する傾向があることが確認できております。<br>たとえば「ゆーざー」という名前のユーザーアカウントを作成すると、ユーザープロファイルのフォルダーは以下のように、日本語を含むパス名になります。</p><blockquote><p>C:\Users\ゆーざー</p></blockquote><p>ポイント対サイト接続用のクライアント パッケージはインストールの過程において、ユーザープロファイルのフォルダー配下に一時フォルダーを作成し、パッケージから展開したファイルを展開します。</p><p>しかし、フォルダー名に日本語を含む環境において、パスを正しく処理できない状況が発生し、冒頭に記載したようなエラーが発生します。</p><h2 id="■-回避策について："><a href="#■-回避策について：" class="headerlink" title="■ 回避策について："></a>■ 回避策について：</h2><p>この事象についての根本的な原因は調査中ですが、回避策としては、コマンドプロンプトを経由してパッケージのインストールを実行するという手法がございます。</p><p>具体的には、管理者権限のコマンドプロンプトから以下のように /T オプションを付加して実行いただくことで、インストール時に使用する作業用フォルダーの場所を明示的に指定することが可能です。</p><p>例：（VPN クライアントパッケージの名称が 10a662cf-a82d-4579-80c8-5b8dc2d3f003.exe の場合） </p><blockquote><p>10a662cf-a82d-4579-80c8-5b8dc2d3f003.exe /T:C:\install</p></blockquote><p>予め C:\install のような空フォルダーを作成しておき、上記のコマンドを実行することで、日本語を含むパス名を避けてインストールを実行することが可能になります。<br>この結果、エラーを回避し、インストールを正しく完了することができます。</p><p>同様のエラーに直面されている場合にお試しください。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;こんにちは。Azure サポートチームの比留間です。&lt;/p&gt;
&lt;p&gt;今回は、Azure 仮想ネットワークに対するポイント対サイト接続用のクライアント パッケージをインストールする際に、”‘azurebox32.ico’が必要です。” という文言のエラーが発生する事象について
      
    
    </summary>
    
    
      <category term="Archive" scheme="https://jpaztech.github.io/tags/Archive/"/>
    
      <category term="Client Package" scheme="https://jpaztech.github.io/tags/Client-Package/"/>
    
  </entry>
  
</feed>
